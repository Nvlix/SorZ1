-- ============================================================
-- FORGE MINIGAME SKIPPER + AUTO HAMMER (MELT / POUR / HAMMER)
-- ============================================================

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Knit

-- Remote references
local ForgeServiceRF
local ProximityServiceRF

-- State
local isHammerMinigameActive = false
local autoHammerRunning = false
local originalMinigames = {}
local lastHammerTime = 0
local HAMMER_COOLDOWN = 0.5
local hammerTask = nil
local stopRequested = false
local debugMode = false

-- References to track minigame state
local hammerMinigameUI = nil
local minigameCompleteFlag = false

-- WindUI
local WindUI
local PepsiForgeWindow
local flags = {}

-- GUI Toggle State
local guiVisible = true
local openButton
local toggleKeybind = "RightControl" -- Default toggle key

----------------------------------------------------------------
-- LOAD WINDUI LIBRARY
----------------------------------------------------------------
local function loadUILibrary()
    local success, lib = pcall(function()
        return loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
    end)
    
    if success then
        WindUI = lib
        return true
    else
        warn("[FORGE UI] Failed to load WindUI Library:", lib)
        return false
    end
end

----------------------------------------------------------------
-- REMOTES
----------------------------------------------------------------
local function initializeRemotes()
    local Packages = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Packages")
    Knit = require(Packages.Knit)
    
    local Services = Packages.Knit.Services
    ForgeServiceRF = Services.ForgeService.RF.ChangeSequence
    ProximityServiceRF = Services.ProximityService.RF.Forge
    
    return ForgeServiceRF ~= nil
end

----------------------------------------------------------------
-- DEBUG LOGGING
----------------------------------------------------------------
local function debugLog(message)
    if debugMode then
        print("[DEBUG] " .. message)
    end
end

----------------------------------------------------------------
-- MINIGAME STATE DETECTION
----------------------------------------------------------------
local function getHammerMinigameUI()
    local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
    local forgeUI = playerGui:WaitForChild("Forge", 5)
    if forgeUI then
        return forgeUI:WaitForChild("HammerMinigame", 3)
    end
    return nil
end

local function isMinigameVisible()
    hammerMinigameUI = getHammerMinigameUI()
    if hammerMinigameUI then
        return hammerMinigameUI.Visible
    end
    return false
end

local function isMinigameTimerComplete()
    if not hammerMinigameUI then
        hammerMinigameUI = getHammerMinigameUI()
    end
    
    if hammerMinigameUI then
        local timerBar = hammerMinigameUI:FindFirstChild("Timer")
        if timerBar then
            local bar = timerBar:FindFirstChild("Bar")
            if bar then
                return bar.Size.X.Scale >= 0.95
            end
        end
    end
    return false
end

----------------------------------------------------------------
-- AUTO HAMMER ENGINE
----------------------------------------------------------------
local function hammerLoop()
    debugLog("Hammer loop started")
    local hammerCount = 0
    local lastCheckTime = tick()
    
    while isHammerMinigameActive and autoHammerRunning and not stopRequested do
        -- Check minigame state every 0.5 seconds
        local currentTime = tick()
        if currentTime - lastCheckTime > 0.5 then
            if not isMinigameVisible() or isMinigameTimerComplete() then
                debugLog("Minigame no longer active, stopping hammer")
                stopRequested = true
                break
            end
            lastCheckTime = currentTime
        end
        
        -- Calculate delay with variation
        local baseDelay = HAMMER_COOLDOWN
        local randomVariation = math.random(-20, 30) / 100
        local totalDelay = math.max(0.3, baseDelay + randomVariation)
        
        debugLog("Waiting " .. string.format("%.2f", totalDelay) .. "s before next hit")
        
        -- Wait with frequent checks
        local startWait = tick()
        while tick() - startWait < totalDelay do
            if not isHammerMinigameActive or not autoHammerRunning or stopRequested then
                debugLog("Breaking during wait")
                return
            end
            task.wait(0.05)
        end
        
        -- Final check before sending
        if not isHammerMinigameActive or not autoHammerRunning or stopRequested then
            debugLog("Breaking before send")
            return
        end
        
        -- Send hammer hit
        local success, result = pcall(function()
            return ForgeServiceRF:InvokeServer(
                "Hammer",
                { 
                    ClientTime = workspace:GetServerTimeNow(),
                    RandomSeed = math.random(1, 1000)
                }
            )
        end)
        
        if success then
            hammerCount = hammerCount + 1
            lastHammerTime = tick()
            debugLog("Hammer hit #" .. hammerCount .. " sent successfully")
            
            -- Check if timer is complete after each hit
            if isMinigameTimerComplete() then
                debugLog("Timer completed after hit #" .. hammerCount)
                stopRequested = true
                break
            end
        else
            debugLog("Hammer hit failed: " .. tostring(result))
        end
    end
    
    debugLog("Hammer loop ended. Total hits: " .. hammerCount)
end

local function startAutoHammer()
    if autoHammerRunning then
        debugLog("Auto hammer already running")
        return
    end
    
    debugLog("Starting auto hammer system")
    autoHammerRunning = true
    stopRequested = false
    minigameCompleteFlag = false
    
    -- Stop any existing task
    if hammerTask then
        task.cancel(hammerTask)
        hammerTask = nil
    end
    
    -- Start new task
    hammerTask = task.spawn(function()
        hammerLoop()
        
        -- Cleanup after loop ends
        autoHammerRunning = false
        hammerTask = nil
        debugLog("Auto hammer task cleaned up")
    end)
end

local function stopAutoHammer()
    debugLog("Stopping auto hammer requested")
    stopRequested = true
    autoHammerRunning = false
    isHammerMinigameActive = false
    minigameCompleteFlag = true
    
    -- Cancel task if it exists
    if hammerTask then
        task.cancel(hammerTask)
        hammerTask = nil
    end
    
    debugLog("Auto hammer fully stopped")
end

----------------------------------------------------------------
-- MINIGAME HOOKING
----------------------------------------------------------------
local function hookMinigameModules()
    local ForgeController = Knit.GetController("ForgeController")
    if not ForgeController or not ForgeController.Minigames then
        warn("[FORGE SKIP] Cannot find ForgeController minigames")
        return false
    end

    print("[FORGE SKIP] Found ForgeController with minigames")

    -- MELT
    if ForgeController.Minigames.MeltMinigame then
        originalMinigames.MeltStart = ForgeController.Minigames.MeltMinigame.Start

        ForgeController.Minigames.MeltMinigame.Start = function(self, data)
            print("[FORGE SKIP] Skipping Melt...")
            local t = workspace:GetServerTimeNow()
            task.wait(0.3)
            print("[FORGE SKIP] Melt skipped!")
            return t - 0.001
        end
    end

    -- POUR
    if ForgeController.Minigames.PourMinigame then
        originalMinigames.PourStart = ForgeController.Minigames.PourMinigame.Start

        ForgeController.Minigames.PourMinigame.Start = function(self, data)
            print("[FORGE SKIP] Skipping Pour...")
            local t = workspace:GetServerTimeNow()
            task.wait(0.3)
            print("[FORGE SKIP] Pour skipped!")
            return t - 0.001
        end
    end

    -- HAMMER - Hook with UI monitoring
    if ForgeController.Minigames.HammerMinigame then
        -- Store original functions
        local originalHammerStart = ForgeController.Minigames.HammerMinigame.Start
        local originalHammerStop = ForgeController.Minigames.HammerMinigame.Stop
        
        -- Get UI reference
        hammerMinigameUI = getHammerMinigameUI()
        
        -- Hook Start function
        ForgeController.Minigames.HammerMinigame.Start = function(self, ...)
            print("[FORGE HOOK] ===== HAMMER MINIGAME STARTED =====")
            
            -- Reset states
            isHammerMinigameActive = true
            autoHammerRunning = false
            stopRequested = false
            minigameCompleteFlag = false
            
            -- Get fresh UI reference
            hammerMinigameUI = getHammerMinigameUI()
            
            -- Start auto hammer if enabled
            if flags.AutoHammerEnabled then
                task.spawn(function()
                    task.wait(0.5)
                    if isMinigameVisible() then
                        print("[FORGE HOOK] UI detected, starting auto hammer...")
                        startAutoHammer()
                    end
                end)
            end
            
            -- Call original function
            if originalHammerStart then
                return originalHammerStart(self, ...)
            end
            return nil
        end

        -- Hook Stop function
        ForgeController.Minigames.HammerMinigame.Stop = function(self, ...)
            print("[FORGE HOOK] ===== HAMMER MINIGAME STOPPED =====")
            
            -- Immediate stop
            stopAutoHammer()
            
            -- Call original function
            if originalHammerStop then
                return originalHammerStop(self, ...)
            end
            return nil
        end
        
        print("[FORGE HOOK] Hammer minigame hooks installed with UI monitoring")
    end

    print("[FORGE SKIP] All minigames hooked successfully")
    return true
end

----------------------------------------------------------------
-- GUI TOGGLE FUNCTIONS
----------------------------------------------------------------
local function toggleGUI()
    if PepsiForgeWindow then
        guiVisible = not guiVisible
        
        if guiVisible then
            PepsiForgeWindow:Open()
            if openButton then
                openButton:Visible(false)
            end
            WindUI:Notify({
                Title = "GUI",
                Content = "GUI opened",
                Icon = "eye",
                Duration = 1.5
            })
        else
            PepsiForgeWindow:Close()
            if openButton then
                openButton:Visible(true)
            end
            WindUI:Notify({
                Title = "GUI",
                Content = "GUI hidden",
                Icon = "eye-off",
                Duration = 1.5
            })
        end
        
        print("[FORGE SYSTEM] GUI toggled: " .. (guiVisible and "VISIBLE" or "HIDDEN"))
    end
end

----------------------------------------------------------------
-- CREATE WINDUI WINDOW WITH OPEN BUTTON
----------------------------------------------------------------
local function createWindUI()
    if not loadUILibrary() then
        warn("[FORGE UI] Failed to load WindUI Library, creating fallback UI")
        return createFallbackUI()
    end
    
    -- Create main window
    PepsiForgeWindow = WindUI:CreateWindow({
        Title = "JawirScript - Auto Forge",
        Folder = "JawirScriptForge",
        Theme = "Dark",
        Size = UDim2.new(0, 500, 0, 420),
        Radius = 12,
        Resizable = true,
        Acrylic = true,
        Background = Color3.fromRGB(30, 30, 35),
        Author = "Auto Forge System",
        ToggleKey = Enum.KeyCode.RightControl, -- Set default toggle key
        OpenButton = { -- Add open button configuration
            Title = "Auto Forge",
            Icon = "hammer",
            Enabled = true,
            Position = UDim2.new(0, 10, 0.5, -50),
            OnlyIcon = false,
            Color = ColorSequence.new(
                Color3.fromHex("#FF6B6B"),
                Color3.fromHex("#4ECDC4")
            )
        }
    })
    
    -- Store open button reference
    openButton = PepsiForgeWindow.OpenButtonMain
    
    -- Create General Tab
    local GeneralTab = PepsiForgeWindow:Tab({
        Title = "Main",
        Desc = "Main Controls"
    })
    
    -- Auto Forge Section
    GeneralTab:Paragraph({
        Title = "âš™ï¸ Auto Forge System",
        Desc = "Skip minigames and auto-hammer"
    })
    
    -- Activation button
    GeneralTab:Button({
        Title = "ðŸ”§ Activate Hooks",
        Desc = "Activate minigame hooks",
        Callback = function()
            local success = hookMinigameModules()
            if success then
                task.wait(0.5)
                WindUI:Notify({
                    Title = "Hooks Activated",
                    Content = "Minigame hooks activated successfully!",
                    Icon = "check-circle",
                    Duration = 3
                })
                print("[FORGE SYSTEM] Hooks activated successfully!")
            end
        end
    })
    
    -- Divider
    GeneralTab:Divider()
    
    -- GUI Toggle button
    GeneralTab:Button({
        Title = "ðŸ‘ï¸ Toggle GUI",
        Desc = "Show/Hide the GUI interface",
        Callback = function()
            toggleGUI()
        end
    })
    
    -- Toggles Section
    GeneralTab:Paragraph({
        Title = "âš¡ Quick Toggles",
        Desc = "Enable/disable features"
    })
    
    -- Auto Hammer toggle
    GeneralTab:Toggle({
        Title = "ðŸ”¨ Auto Hammer",
        Desc = "Automatically hammer during minigame",
        Value = true,
        Callback = function(value)
            flags.AutoHammerEnabled = value
            WindUI:Notify({
                Title = "Auto Hammer",
                Content = value and "ENABLED" or "DISABLED",
                Icon = "hammer",
                Duration = 2
            })
            print("[FORGE SYSTEM] Auto Hammer: " .. (value and "ENABLED" or "DISABLED"))
        end
    })
    
    -- Melt Skip toggle
    GeneralTab:Toggle({
        Title = "ðŸ”¥ Skip Melt",
        Desc = "Skip the melt minigame",
        Value = true,
        Callback = function(value)
            flags.SkipMeltEnabled = value
            print("[FORGE SYSTEM] Skip Melt: " .. (value and "ENABLED" or "DISABLED"))
        end
    })
    
    -- Pour Skip toggle
    GeneralTab:Toggle({
        Title = "ðŸ’§ Skip Pour",
        Desc = "Skip the pour minigame",
        Value = true,
        Callback = function(value)
            flags.SkipPourEnabled = value
            print("[FORGE SYSTEM] Skip Pour: " .. (value and "ENABLED" or "DISABLED"))
        end
    })
    
    -- Debug Mode toggle
    GeneralTab:Toggle({
        Title = "ðŸ” Debug Mode",
        Desc = "Enable debug logging",
        Value = false,
        Callback = function(value)
            debugMode = value
            WindUI:Notify({
                Title = "Debug Mode",
                Content = value and "ENABLED" or "DISABLED",
                Icon = "bug",
                Duration = 2
            })
            print("[FORGE SYSTEM] Debug Mode: " .. (value and "ENABLED" or "DISABLED"))
        end
    })
    
    -- Create Settings Tab
    local SettingsTab = PepsiForgeWindow:Tab({
        Title = "Settings",
        Desc = "Configuration Settings"
    })
    
    -- GUI Settings Section
    SettingsTab:Paragraph({
        Title = "ðŸ–¥ï¸ GUI Settings",
        Desc = "Configure GUI appearance and behavior"
    })
    
    -- GUI Toggle Keybind
    SettingsTab:Keybind({
        Title = "Toggle GUI Key",
        Desc = "Key to toggle GUI visibility",
        Value = "RightControl",
        Callback = function(key)
            toggleKeybind = key
            WindUI:Notify({
                Title = "Keybind Updated",
                Content = "Press " .. key .. " to toggle GUI",
                Icon = "keyboard",
                Duration = 3
            })
            print("[FORGE SYSTEM] GUI toggle keybind set to: " .. key)
        end
    })
    
    -- Open Button Style
    SettingsTab:Dropdown({
        Title = "Open Button Style",
        Desc = "Style of the open button",
        Value = "Full",
        Values = {"Full", "Icon Only", "Text Only"},
        Callback = function(value)
            if openButton then
                local config = {
                    OnlyIcon = value == "Icon Only"
                }
                PepsiForgeWindow:EditOpenButton(config)
                WindUI:Notify({
                    Title = "Button Style",
                    Content = "Changed to: " .. value,
                    Icon = "layout",
                    Duration = 2
                })
            end
        end
    })
    
    -- Hammer Speed Slider
    SettingsTab:Slider({
        Title = "Hammer Speed",
        Desc = "Delay between hammer hits",
        Value = {Default = HAMMER_COOLDOWN, Min = 0.1, Max = 1.0},
        Callback = function(value)
            HAMMER_COOLDOWN = value
            WindUI:Notify({
                Title = "Hammer Speed",
                Content = "Set to: " .. string.format("%.1f", value) .. "s",
                Icon = "gauge",
                Duration = 2
            })
            print("[FORGE SYSTEM] Hammer cooldown set to: " .. string.format("%.1f", value) .. "s")
        end
    })
    
    -- Auto initialize toggle
    SettingsTab:Toggle({
        Title = "âš™ï¸ Auto Initialize",
        Desc = "Automatically initialize on game start",
        Value = true,
        Callback = function(value)
            flags.AutoInitialize = value
            print("[FORGE SYSTEM] Auto Initialize: " .. (value and "ENABLED" or "DISABLED"))
        end
    })
    
    -- Control Section
    SettingsTab:Paragraph({
        Title = "ðŸ›‘ Emergency Controls",
        Desc = "Manual control buttons"
    })
    
    -- Emergency Stop button
    SettingsTab:Button({
        Title = "ðŸ›‘ Emergency Stop",
        Desc = "Immediately stop all auto systems",
        Callback = function()
            WindUI:Notify({
                Title = "Emergency Stop",
                Content = "Stopping all auto systems...",
                Icon = "alert-octagon",
                Duration = 2
            })
            print("[EMERGENCY] Manual stop triggered")
            stopAutoHammer()
        end
    })
    
    -- Status display button
    SettingsTab:Button({
        Title = "ðŸ“Š Check Status",
        Desc = "Display current system status",
        Callback = function()
            local statusText = "=== FORGE SYSTEM STATUS ===\n"
            statusText = statusText .. "Minigame Active: " .. tostring(isHammerMinigameActive) .. "\n"
            statusText = statusText .. "Auto Hammer Running: " .. tostring(autoHammerRunning) .. "\n"
            statusText = statusText .. "Hammer Task: " .. (hammerTask and "ACTIVE" or "INACTIVE") .. "\n"
            statusText = statusText .. "Cooldown: " .. string.format("%.1f", HAMMER_COOLDOWN) .. "s\n"
            statusText = statusText .. "UI Visible: " .. tostring(isMinigameVisible()) .. "\n"
            statusText = statusText .. "Hooks Active: " .. (originalMinigames.MeltStart and "YES" or "NO") .. "\n"
            statusText = statusText .. "GUI Visible: " .. tostring(guiVisible) .. "\n"
            statusText = statusText .. "Toggle Key: " .. toggleKeybind
            
            WindUI:Dialog({
                Title = "System Status",
                Content = statusText,
                Icon = "info",
                Buttons = {
                    {
                        Title = "Close",
                        Callback = function() end
                    }
                }
            })
        end
    })
    
    -- Cleanup button
    SettingsTab:Button({
        Title = "ðŸ§¹ Cleanup System",
        Desc = "Clean up all resources",
        Callback = function()
            WindUI:Notify({
                Title = "Cleanup",
                Content = "Cleaning up system resources...",
                Icon = "broom",
                Duration = 2
            })
            print("[FORGE SYSTEM] Cleaning up...")
            stopAutoHammer()
            print("[FORGE SYSTEM] Cleanup complete")
        end
    })
    
    -- Create Info Tab
    local InfoTab = PepsiForgeWindow:Tab({
        Title = "Info",
        Desc = "System Information"
    })
    
    InfoTab:Paragraph({
        Title = "ðŸ“– Auto Forge System v1.0",
        Desc = "Automatically skips forge minigames and hammers for you.\n\nFeatures:\nâ€¢ Skip Melt minigame\nâ€¢ Skip Pour minigame\nâ€¢ Auto Hammer during hammer minigame\nâ€¢ Adjustable hammer speed\nâ€¢ Emergency stop\nâ€¢ Debug mode\nâ€¢ GUI toggle button\nâ€¢ Customizable open button\n\nBy JawirScript"
    })
    
    InfoTab:Paragraph({
        Title = "ðŸ”§ GUI Controls",
        Desc = "â€¢ Press RightControl to toggle GUI\nâ€¢ Click open button to show GUI\nâ€¢ Use toggle button in Main tab\nâ€¢ Configure keybind in Settings"
    })
    
    InfoTab:Button({
        Title = "ðŸ“ž Report Issue",
        Desc = "Open issue reporting",
        Callback = function()
            WindUI:Dialog({
                Title = "Report Issue",
                Content = "If you encounter any issues:\n1. Enable debug mode\n2. Check the console for logs\n3. Take screenshots\n4. Contact the developer",
                Icon = "help-circle",
                Buttons = {
                    {
                        Title = "Close",
                        Callback = function() end
                    }
                }
            })
        end
    })
    
    -- Setup keybind listener
    local function setupKeybindListener()
        UserInputService.InputBegan:Connect(function(input, gameProcessed)
            if not gameProcessed then
                if input.KeyCode == Enum.KeyCode[toggleKeybind] then
                    toggleGUI()
                end
            end
        end)
    end
    
    setupKeybindListener()
    
    print("[FORGE SYSTEM] WindUI loaded successfully")
    return true
end

----------------------------------------------------------------
-- FALLBACK UI (if WindUI fails)
----------------------------------------------------------------
local function createFallbackUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ForgeSkipUI"
    screenGui.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 250, 0, 180)
    frame.Position = UDim2.new(0.5, -125, 0, 10)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    frame.BorderColor3 = Color3.fromRGB(60, 60, 60)
    frame.BorderSizePixel = 2
    frame.Parent = screenGui

    local title = Instance.new("TextLabel")
    title.Text = "âš¡ FORGE AUTO SYSTEM"
    title.Size = UDim2.new(1, 0, 0, 30)
    title.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    title.TextColor3 = Color3.fromRGB(255, 200, 100)
    title.Font = Enum.Font.Code
    title.TextSize = 16
    title.Parent = frame

    local status = Instance.new("TextLabel")
    status.Text = "Status: Ready"
    status.Size = UDim2.new(1, 0, 0, 25)
    status.Position = UDim2.new(0, 0, 0.2, 0)
    status.BackgroundTransparency = 1
    status.TextColor3 = Color3.fromRGB(200, 200, 200)
    status.Font = Enum.Font.Code
    status.TextSize = 12
    status.Parent = frame

    local hookBtn = Instance.new("TextButton")
    hookBtn.Text = "ACTIVATE HOOKS"
    hookBtn.Size = UDim2.new(0.8, 0, 0, 40)
    hookBtn.Position = UDim2.new(0.1, 0, 0.55, 0)
    hookBtn.BackgroundColor3 = Color3.fromRGB(60, 140, 60)
    hookBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    hookBtn.Font = Enum.Font.Code
    hookBtn.TextSize = 14
    hookBtn.Parent = frame

    hookBtn.MouseButton1Click:Connect(function()
        local s = hookMinigameModules()
        if s then
            hookBtn.Text = "HOOKS ACTIVE"
            hookBtn.BackgroundColor3 = Color3.fromRGB(140, 60, 60)
            status.Text = "Status: Hooks Active"
        end
    end)

    return screenGui
end

----------------------------------------------------------------
-- UI MONITORING SYSTEM
----------------------------------------------------------------
local function createUIMonitor()
    task.spawn(function()
        while task.wait(0.2) do
            if autoHammerRunning and flags.AutoHammerEnabled then
                -- Check UI visibility
                if not isMinigameVisible() or isMinigameTimerComplete() then
                    debugLog("UI disappeared or timer complete, stopping hammer")
                    stopAutoHammer()
                end
            end
        end
    end)
end

----------------------------------------------------------------
-- MAIN INITIALIZATION
----------------------------------------------------------------
local function setupForgeSkip()
    print("========================================")
    print("FORGE SKIPPER + AUTO HAMMER INITIALIZING")
    print("========================================")

    local ok = initializeRemotes()
    if not ok then
        warn("[FORGE SKIP] Remote initialization failed")
        return
    end

    -- Create UI
    createWindUI()
    
    -- Start UI monitor
    createUIMonitor()
    
    -- Set default flags
    flags.AutoHammerEnabled = true
    
    -- Safety cleanup
    Players.LocalPlayer.AncestryChanged:Connect(function()
        if not Players.LocalPlayer.Parent then
            print("[CLEANUP] Player leaving, stopping everything")
            stopAutoHammer()
        end
    end)
    
    -- Game close cleanup
    game:BindToClose(function()
        print("[SHUTDOWN] Game closing, stopping auto hammer")
        stopAutoHammer()
    end)
    
    print("[FORGE SYSTEM] Initialization complete")
    print("[FORGE SYSTEM] Default cooldown: " .. HAMMER_COOLDOWN .. "s")
    print("[FORGE SYSTEM] GUI Toggle Key: " .. toggleKeybind)
    print("[FORGE SYSTEM] Use RightControl to toggle GUI")
    print("========================================")
end

-- Delayed initialization
task.spawn(function()
    task.wait(6)
    
    local success, err = pcall(setupForgeSkip)
    if not success then
        warn("[FORGE SYSTEM] Initialization error:", err)
    end
end)

-- Return functions for external use
return {
    StopHammer = stopAutoHammer,
    StartHammer = startAutoHammer,
    ToggleGUI = toggleGUI,
    GetStatus = function()
        return {
            MinigameActive = isHammerMinigameActive,
            AutoRunning = autoHammerRunning,
            Cooldown = HAMMER_COOLDOWN,
            UIVisible = isMinigameVisible(),
            TimerComplete = isMinigameTimerComplete(),
            GUIVisible = guiVisible,
            ToggleKey = toggleKeybind,
            Flags = flags
        }
    end,
    SetDebugMode = function(value)
        debugMode = value
    end,
    SetToggleKey = function(key)
        toggleKeybind = key
    end
}
