-- ============================================================
-- FORGE SYSTEM + FLOATING HOTKEY BUTTON WITH PEPSI UI
-- ============================================================

-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Variables
local library = nil
local PepsiForgeWindow = nil
local hotkeyButton = nil
local Knit = nil
local ForgeServiceRF = nil

-- State
local isHammerMinigameActive = false
local autoHammerRunning = false
local originalMinigames = {}
local lastHammerTime = 0
local HAMMER_COOLDOWN = 0.5
local hammerTask = nil
local stopRequested = false

-- Settings
local HOTKEY_IMAGE_URL = "https://i.imgur.com/0QvY6vJ.png"
local HOTKEY_KEY = Enum.KeyCode.RightShift
local buttonPosition = UDim2.new(0, 100, 0, 100)

-- Flags
local flags = {
    AutoHammerEnabled = true,
    SkipMeltEnabled = true,
    SkipPourEnabled = true,
    ShowHotkeyButton = true,
    HotkeyEnabled = true
}

----------------------------------------------------------------
-- FLOATING HOTKEY BUTTON
----------------------------------------------------------------
local function createHotkeyButton()
    local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
    
    -- Create GUI
    local hotkeyGui = Instance.new("ScreenGui")
    hotkeyGui.Name = "HotkeyButtonGUI"
    hotkeyGui.ResetOnSpawn = false
    hotkeyGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    hotkeyGui.Parent = playerGui
    
    -- Create button
    hotkeyButton = Instance.new("ImageButton")
    hotkeyButton.Name = "HotkeyButton"
    hotkeyButton.Size = UDim2.new(0, 50, 0, 50)
    hotkeyButton.Position = buttonPosition
    hotkeyButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    hotkeyButton.BackgroundTransparency = 0.3
    hotkeyButton.BorderSizePixel = 0
    hotkeyButton.AutoButtonColor = false
    
    -- Rounded corners
    local uiCorner = Instance.new("UICorner")
    uiCorner.CornerRadius = UDim.new(0.2, 0)
    uiCorner.Parent = hotkeyButton
    
    -- Border
    local uiStroke = Instance.new("UIStroke")
    uiStroke.Color = Color3.fromRGB(0, 170, 255)
    uiStroke.Thickness = 2
    uiStroke.Transparency = 0.3
    uiStroke.Parent = hotkeyButton
    
    -- Image from Imgur
    local imageLabel = Instance.new("ImageLabel")
    imageLabel.Name = "ButtonImage"
    imageLabel.Size = UDim2.new(0.8, 0, 0.8, 0)
    imageLabel.Position = UDim2.new(0.1, 0, 0.1, 0)
    imageLabel.BackgroundTransparency = 1
    imageLabel.Image = HOTKEY_IMAGE_URL
    imageLabel.Parent = hotkeyButton
    
    -- Tooltip
    local tooltip = Instance.new("TextLabel")
    tooltip.Name = "Tooltip"
    tooltip.Text = "Press: RSHIFT\nDrag to move"
    tooltip.Size = UDim2.new(0, 100, 0, 40)
    tooltip.Position = UDim2.new(1, 10, 0.5, -20)
    tooltip.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    tooltip.TextColor3 = Color3.fromRGB(200, 200, 200)
    tooltip.Font = Enum.Font.Gotham
    tooltip.TextSize = 10
    tooltip.TextWrapped = true
    tooltip.Visible = false
    tooltip.BorderSizePixel = 0
    tooltip.ZIndex = 10
    
    local tooltipCorner = Instance.new("UICorner")
    tooltipCorner.CornerRadius = UDim.new(0.2, 0)
    tooltipCorner.Parent = tooltip
    
    tooltip.Parent = hotkeyButton
    
    -- Hover effects
    hotkeyButton.MouseEnter:Connect(function()
        if UserInputService.MouseEnabled then
            tooltip.Visible = true
            TweenService:Create(hotkeyButton, TweenInfo.new(0.2), {
                BackgroundTransparency = 0.1,
                Size = UDim2.new(0, 55, 0, 55)
            }):Play()
        end
    end)
    
    hotkeyButton.MouseLeave:Connect(function()
        if UserInputService.MouseEnabled then
            tooltip.Visible = false
            TweenService:Create(hotkeyButton, TweenInfo.new(0.2), {
                BackgroundTransparency = 0.3,
                Size = UDim2.new(0, 50, 0, 50)
            }):Play()
        end
    end)
    
    -- Click animation
    local function animateClick()
        TweenService:Create(hotkeyButton, TweenInfo.new(0.1), {
            Size = UDim2.new(0, 45, 0, 45)
        }):Play()
        task.wait(0.1)
        TweenService:Create(hotkeyButton, TweenInfo.new(0.1), {
            Size = UDim2.new(0, 50, 0, 50)
        }):Play()
    end
    
    -- Press Right Shift
    local function pressRightShift()
        if not flags.HotkeyEnabled then
            return
        end
        
        -- Simulate key press
        pcall(function()
            VirtualInputManager:SendKeyEvent(true, HOTKEY_KEY, false, nil)
            task.wait(0.05)
            VirtualInputManager:SendKeyEvent(false, HOTKEY_KEY, false, nil)
        end)
        
        -- Visual feedback
        TweenService:Create(hotkeyButton, TweenInfo.new(0.1), {
            BackgroundColor3 = Color3.fromRGB(0, 255, 100)
        }):Play()
        task.wait(0.1)
        TweenService:Create(hotkeyButton, TweenInfo.new(0.1), {
            BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        }):Play()
    end
    
    -- Connect click
    hotkeyButton.MouseButton1Click:Connect(function()
        animateClick()
        pressRightShift()
    end)
    
    -- Touch support
    if UserInputService.TouchEnabled then
        hotkeyButton.TouchTap:Connect(function()
            animateClick()
            pressRightShift()
        end)
    end
    
    -- Drag functionality
    local dragging = false
    local dragStart = nil
    local startPosition = nil
    
    local function updatePosition(input)
        if not dragging then
            return
        end
        
        local delta = input.Position - dragStart
        local newPosition = UDim2.new(
            startPosition.X.Scale,
            startPosition.X.Offset + delta.X,
            startPosition.Y.Scale,
            startPosition.Y.Offset + delta.Y
        )
        
        hotkeyButton.Position = newPosition
        buttonPosition = newPosition
    end
    
    hotkeyButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPosition = hotkeyButton.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    hotkeyButton.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            updatePosition(input)
        end
    end)
    
    hotkeyButton.Parent = hotkeyGui
    hotkeyButton.Visible = flags.ShowHotkeyButton
    
    return hotkeyButton
end

----------------------------------------------------------------
-- LOAD PEPSI UI LIBRARY
----------------------------------------------------------------
local function loadPepsiUI()
    local success, lib = pcall(function()
        return loadstring(game:GetObjects("rbxassetid://7657867786")[1].Source)()
    end)
    
    if success then
        library = lib
        return true
    end
    return false
end

----------------------------------------------------------------
-- CREATE PEPSI UI
----------------------------------------------------------------
local function createPepsiUI()
    if not loadPepsiUI() then
        warn("[UI] Failed to load Pepsi UI")
        return
    end
    
    -- Create window
    PepsiForgeWindow = library:CreateWindow({
        Name = "Forge System",
        Themeable = {
            Info = "Floating Hotkey + Auto Forge"
        }
    })
    
    -- Create tab
    local MainTab = PepsiForgeWindow:CreateTab({
        Name = "Main"
    })
    
    -- Hotkey Section
    local HotkeySection = MainTab:CreateSection({
        Name = "Hotkey Button",
        Side = "Left"
    })
    
    HotkeySection:AddToggle({
        Name = "Enable Hotkey Button",
        Value = flags.ShowHotkeyButton,
        Flag = "ShowHotkeyButton",
        Callback = function(value)
            flags.ShowHotkeyButton = value
            if hotkeyButton then
                hotkeyButton.Visible = value
            end
            print("[Hotkey] Button visible:", value)
        end
    })
    
    HotkeySection:AddToggle({
        Name = "Enable Hotkey Function",
        Value = flags.HotkeyEnabled,
        Flag = "HotkeyEnabled",
        Callback = function(value)
            flags.HotkeyEnabled = value
            print("[Hotkey] Function enabled:", value)
        end
    })
    
    HotkeySection:AddTextbox({
        Name = "Image URL",
        Value = HOTKEY_IMAGE_URL,
        Placeholder = "Enter Imgur URL",
        Callback = function(value)
            if value and value ~= "" then
                HOTKEY_IMAGE_URL = value
                if hotkeyButton then
                    local image = hotkeyButton:FindFirstChild("ButtonImage")
                    if image then
                        image.Image = value
                    end
                end
                print("[Hotkey] Image updated")
            end
        end
    })
    
    HotkeySection:AddButton({
        Name = "Test Hotkey",
        Callback = function()
            if hotkeyButton then
                hotkeyButton.MouseButton1Click:Fire()
            end
        end
    })
    
    HotkeySection:AddButton({
        Name = "Reset Position",
        Callback = function()
            if hotkeyButton then
                hotkeyButton.Position = UDim2.new(0, 100, 0, 100)
                buttonPosition = hotkeyButton.Position
            end
        end
    })
    
    -- Forge Section
    local ForgeSection = MainTab:CreateSection({
        Name = "Auto Forge",
        Side = "Right"
    })
    
    ForgeSection:AddButton({
        Name = "Activate Hooks",
        Callback = function()
            local success = hookMinigameModules()
            if success then
                print("[Forge] Hooks activated")
            end
        end
    })
    
    ForgeSection:AddToggle({
        Name = "Auto Hammer",
        Value = flags.AutoHammerEnabled,
        Flag = "AutoHammerEnabled",
        Callback = function(value)
            flags.AutoHammerEnabled = value
            print("[Forge] Auto hammer:", value)
        end
    })
    
    ForgeSection:AddToggle({
        Name = "Skip Melt",
        Value = flags.SkipMeltEnabled,
        Flag = "SkipMeltEnabled",
        Callback = function(value)
            flags.SkipMeltEnabled = value
            print("[Forge] Skip melt:", value)
        end
    })
    
    ForgeSection:AddToggle({
        Name = "Skip Pour",
        Value = flags.SkipPourEnabled,
        Flag = "SkipPourEnabled",
        Callback = function(value)
            flags.SkipPourEnabled = value
            print("[Forge] Skip pour:", value)
        end
    })
    
    ForgeSection:AddSlider({
        Name = "Hammer Speed",
        Value = HAMMER_COOLDOWN,
        Min = 0.1,
        Max = 1.0,
        Precise = 1,
        Flag = "HammerSpeed",
        Format = function(value)
            return string.format("%.1f", value) .. "s delay"
        end,
        Callback = function(value)
            HAMMER_COOLDOWN = value
            print("[Forge] Cooldown:", value)
        end
    })
    
    -- Control Section
    local ControlSection = MainTab:CreateSection({
        Name = "Control",
        Side = "Left"
    })
    
    ControlSection:AddButton({
        Name = "Start Auto Hammer",
        Callback = function()
            startAutoHammer()
        end
    })
    
    ControlSection:AddButton({
        Name = "Stop Auto Hammer",
        Callback = function()
            stopAutoHammer()
        end
    })
    
    -- Settings Section
    local SettingsSection = MainTab:CreateSection({
        Name = "Settings",
        Side = "Right"
    })
    
    SettingsSection:AddKeybind({
        Name = "Toggle Hotkey Button",
        Value = Enum.KeyCode.F,
        Callback = function()
            flags.ShowHotkeyButton = not flags.ShowHotkeyButton
            if hotkeyButton then
                hotkeyButton.Visible = flags.ShowHotkeyButton
            end
            print("[Hotkey] Toggled:", flags.ShowHotkeyButton)
        end
    })
    
    SettingsSection:AddButton({
        Name = "Status Info",
        Callback = function()
            print("=== STATUS ===")
            print("Hotkey Button:", hotkeyButton and "CREATED" or "NOT CREATED")
            print("Hotkey Visible:", flags.ShowHotkeyButton)
            print("Hotkey Enabled:", flags.HotkeyEnabled)
            print("Auto Hammer:", autoHammerRunning and "RUNNING" or "STOPPED")
            print("Minigame Active:", isHammerMinigameActive)
            print("=============")
        end
    })
    
    print("[UI] Pepsi UI created successfully")
end

----------------------------------------------------------------
-- INITIALIZE REMOTES
----------------------------------------------------------------
local function initializeRemotes()
    local success, result = pcall(function()
        local Packages = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Packages")
        Knit = require(Packages.Knit)
        return Knit
    end)
    
    if not success then
        return false
    end
    
    local Packages = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Packages")
    local Services = Packages.Knit.Services
    
    local success1, result1 = pcall(function()
        ForgeServiceRF = Services.ForgeService.RF.ChangeSequence
        return ForgeServiceRF
    end)
    
    return success1 and ForgeServiceRF ~= nil
end

----------------------------------------------------------------
-- MINIGAME DETECTION
----------------------------------------------------------------
local function getHammerMinigameUI()
    local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
    local forgeUI = playerGui:FindFirstChild("Forge")
    if forgeUI then
        return forgeUI:FindFirstChild("HammerMinigame")
    end
    return nil
end

local function isMinigameVisible()
    local ui = getHammerMinigameUI()
    if ui then
        return ui.Visible
    end
    return false
end

----------------------------------------------------------------
-- AUTO HAMMER ENGINE
----------------------------------------------------------------
local function hammerLoop()
    print("[HAMMER] Loop started")
    local hammerCount = 0
    
    while isHammerMinigameActive and autoHammerRunning and not stopRequested do
        if not isMinigameVisible() then
            stopRequested = true
            break
        end
        
        local delay = HAMMER_COOLDOWN + math.random(-20, 30) / 100
        delay = math.max(0.3, delay)
        
        local startWait = tick()
        while tick() - startWait < delay do
            if stopRequested then
                return
            end
            task.wait(0.05)
        end
        
        if stopRequested then
            return
        end
        
        local success, result = pcall(function()
            return ForgeServiceRF:InvokeServer(
                "Hammer",
                { 
                    ClientTime = workspace:GetServerTimeNow(),
                    RandomSeed = math.random(1, 1000)
                }
            )
        end)
        
        if success then
            hammerCount = hammerCount + 1
        end
    end
    
    print("[HAMMER] Loop ended. Hits:", hammerCount)
end

local function startAutoHammer()
    if autoHammerRunning then
        return
    end
    
    autoHammerRunning = true
    stopRequested = false
    
    if hammerTask then
        task.cancel(hammerTask)
    end
    
    hammerTask = task.spawn(hammerLoop)
end

local function stopAutoHammer()
    stopRequested = true
    autoHammerRunning = false
    isHammerMinigameActive = false
    
    if hammerTask then
        task.cancel(hammerTask)
        hammerTask = nil
    end
end

----------------------------------------------------------------
-- MINIGAME HOOKING
----------------------------------------------------------------
local function hookMinigameModules()
    local success, ForgeController = pcall(function()
        return Knit.GetController("ForgeController")
    end)
    
    if not success or not ForgeController or not ForgeController.Minigames then
        return false
    end

    -- Melt
    if ForgeController.Minigames.MeltMinigame then
        originalMinigames.MeltStart = ForgeController.Minigames.MeltMinigame.Start

        ForgeController.Minigames.MeltMinigame.Start = function(self, data)
            if flags.SkipMeltEnabled then
                local t = workspace:GetServerTimeNow()
                task.wait(0.3)
                return t - 0.001
            elseif originalMinigames.MeltStart then
                return originalMinigames.MeltStart(self, data)
            end
        end
    end

    -- Pour
    if ForgeController.Minigames.PourMinigame then
        originalMinigames.PourStart = ForgeController.Minigames.PourMinigame.Start

        ForgeController.Minigames.PourMinigame.Start = function(self, data)
            if flags.SkipPourEnabled then
                local t = workspace:GetServerTimeNow()
                task.wait(0.3)
                return t - 0.001
            elseif originalMinigames.PourStart then
                return originalMinigames.PourStart(self, data)
            end
        end
    end

    -- Hammer
    if ForgeController.Minigames.HammerMinigame then
        local originalHammerStart = ForgeController.Minigames.HammerMinigame.Start
        local originalHammerStop = ForgeController.Minigames.HammerMinigame.Stop
        
        ForgeController.Minigames.HammerMinigame.Start = function(self, ...)
            isHammerMinigameActive = true
            
            if flags.AutoHammerEnabled then
                task.spawn(function()
                    task.wait(0.5)
                    if isMinigameVisible() then
                        startAutoHammer()
                    end
                end)
            end
            
            if originalHammerStart then
                return originalHammerStart(self, ...)
            end
            return nil
        end

        ForgeController.Minigames.HammerMinigame.Stop = function(self, ...)
            stopAutoHammer()
            
            if originalHammerStop then
                return originalHammerStop(self, ...)
            end
            return nil
        end
    end

    return true
end

----------------------------------------------------------------
-- MAIN SETUP
----------------------------------------------------------------
local function setupSystem()
    print("=== FORGE SYSTEM ===")
    
    -- Initialize
    local remotesOk = initializeRemotes()
    if not remotesOk then
        warn("Failed to initialize remotes")
        return
    end
    
    -- Create hotkey button
    createHotkeyButton()
    print("Hotkey button created")
    
    -- Create Pepsi UI
    createPepsiUI()
    print("Pepsi UI created")
    
    -- Cleanup
    Players.LocalPlayer.AncestryChanged:Connect(function()
        if not Players.LocalPlayer.Parent then
            stopAutoHammer()
        end
    end)
    
    print("System ready!")
    print("- Floating hotkey button (Right Shift)")
    print("- Drag to move")
    print("- Pepsi UI for controls")
end

-- Start
task.spawn(function()
    task.wait(5)
    local success, err = pcall(setupSystem)
    if not success then
        warn("Setup error:", err)
    end
end)

-- API
return {
    -- Hotkey
    PressHotkey = function()
        if hotkeyButton then
            hotkeyButton.MouseButton1Click:Fire()
        end
    end,
    UpdateImage = function(url)
        if url and hotkeyButton then
            local image = hotkeyButton:FindFirstChild("ButtonImage")
            if image then
                image.Image = url
            end
        end
    end,
    
    -- Forge
    Activate = hookMinigameModules,
    StartHammer = startAutoHammer,
    StopHammer = stopAutoHammer,
    
    -- Status
    GetStatus = function()
        return {
            HotkeyVisible = flags.ShowHotkeyButton,
            HotkeyEnabled = flags.HotkeyEnabled,
            HammerRunning = autoHammerRunning
        }
    end
}
