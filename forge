-- âš™ï¸ Forge Automation - Auto Sequence Detector with Mobile GUI
local success, library = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/RegularVynixu/UI-Libraries/main/Vynixius/Source.lua"))()
end)

if not success or not library then
    -- Fallback ke method lain
    local libraryObjects = game:GetObjects("rbxassetid://7657867786")
    if #libraryObjects > 0 then
        library = loadstring(libraryObjects[1].Source)()
    else
        warn("Failed to load UI library")
        return
    end
end

local Wait = library.subs.Wait or task.wait

-- ðŸ”° Anti-AFK System
local VirtualUser = game:GetService("VirtualUser")
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    pcall(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end)
end)

-- ðŸ”° Window utama
local ForgeAutomation = library:CreateWindow({
    Name = "Forge Sequence Automation",
    Themeable = {
        Info = "Auto Detect & Execute Forge Sequences"
    }
})

-- ðŸ”° Variables
local autoForgeEnabled = false
local forgeThread = nil
local currentSequence = "Idle"
local isProcessing = false

-- ðŸ”° Mobile GUI Variables
local mobileToggleEnabled = true
local mobileToggleButton = nil
local guiVisible = true
local isMobile = false

-- ðŸ”° Check if running on mobile
local function checkIfMobile()
    local UIS = game:GetService("UserInputService")
    return UIS.TouchEnabled
end

-- ðŸ”° Create Mobile Toggle Button
local function createMobileToggleButton()
    pcall(function()
        -- Cek apakah sudah ada button
        if mobileToggleButton and mobileToggleButton.Parent then
            mobileToggleButton.Parent:Destroy()
        end
        
        -- Buat ScreenGui
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "ForgeAutoMobileGUI"
        screenGui.Parent = game:GetService("CoreGui") or game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
        screenGui.ResetOnSpawn = false
        screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        
        -- Buat toggle button
        mobileToggleButton = Instance.new("TextButton")
        mobileToggleButton.Name = "MobileToggle"
        mobileToggleButton.Text = "ðŸ“±\nFORGE\nAUTO"
        mobileToggleButton.Font = Enum.Font.GothamBold
        mobileToggleButton.TextSize = 14
        mobileToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        mobileToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        mobileToggleButton.BorderSizePixel = 0
        mobileToggleButton.Size = UDim2.new(0, 70, 0, 70)
        mobileToggleButton.Position = UDim2.new(0.85, 0, 0.15, 0)
        mobileToggleButton.Parent = screenGui
        
        -- Style button
        mobileToggleButton.AutoButtonColor = true
        
        -- Rounded corners
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0.2, 0)
        corner.Parent = mobileToggleButton
        
        -- Shadow effect
        local shadow = Instance.new("UIStroke")
        shadow.Color = Color3.fromRGB(100, 100, 150)
        shadow.Thickness = 2
        shadow.Parent = mobileToggleButton
        
        -- Toggle function
        mobileToggleButton.MouseButton1Click:Connect(function()
            guiVisible = not guiVisible
            
            if guiVisible then
                ForgeAutomation:Show()
                mobileToggleButton.Text = "ðŸ“±\nHIDE\nGUI"
                mobileToggleButton.BackgroundColor3 = Color3.fromRGB(40, 100, 200)
            else
                ForgeAutomation:Hide()
                mobileToggleButton.Text = "ðŸ“±\nSHOW\nGUI"
                mobileToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
            end
        end)
        
        -- Make draggable
        local dragging = false
        local dragStart, startPos
        
        mobileToggleButton.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                dragStart = input.Position
                startPos = mobileToggleButton.Position
            end
        end)
        
        mobileToggleButton.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = false
            end
        end)
        
        game:GetService("UserInputService").InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local delta = input.Position - dragStart
                mobileToggleButton.Position = UDim2.new(
                    startPos.X.Scale, 
                    startPos.X.Offset + delta.X,
                    startPos.Y.Scale, 
                    startPos.Y.Offset + delta.Y
                )
            end
        end)
    end)
end

-- ðŸ”° Toggle Mobile Button
local function toggleMobileButton(enable)
    mobileToggleEnabled = enable
    
    if enable then
        createMobileToggleButton()
    else
        pcall(function()
            if mobileToggleButton and mobileToggleButton.Parent then
                mobileToggleButton.Parent:Destroy()
            end
        end)
    end
end

-- ðŸ”° Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- ðŸ”° Remote Function
local ForgeRF
local function getForgeRF()
    if not ForgeRF then
        ForgeRF = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Packages")
            :WaitForChild("Knit"):WaitForChild("Services"):WaitForChild("ForgeService")
            :WaitForChild("RF"):WaitForChild("ChangeSequence")
    end
    return ForgeRF
end

-- ðŸ”° Execute next sequence
local function executeNextSequence(currentSeq)
    local nextSequenceMap = {
        Melt = "Pour",
        Pour = "Hammer",
        Hammer = "Water",
        Water = "Melt"
    }
    
    local nextSeq = nextSequenceMap[currentSeq]
    if not nextSeq then
        return false
    end
    
    -- Buat args berdasarkan sequence
    local args
    if nextSeq == "Melt" then
        args = {
            "Melt",
            {
                FastForge = false,
                ItemType = "",
                Ores = {}
            }
        }
    else
        args = {
            nextSeq,
            {
                ClientTime = tick()
            }
        }
    end
    
    -- Execute sequence
    local success, err = pcall(function()
        getForgeRF():InvokeServer(unpack(args))
    end)
    
    if success then
        print("Executed:", nextSeq)
        currentSequence = nextSeq
        return true
    else
        print("Failed:", nextSeq, ":", err)
        return false
    end
end

-- ðŸ”° Hook untuk mendeteksi sequence
local originalFireServer
local sequenceHistory = {}
local lastSequenceTime = 0

local function setupHook()
    pcall(function()
        local forgeRF = getForgeRF()
        
        if not forgeRF then
            return false
        end
        
        originalFireServer = originalFireServer or forgeRF.InvokeServer
        
        forgeRF.InvokeServer = function(self, ...)
            local args = {...}
            local result = originalFireServer(self, ...)
            
            if #args >= 1 then
                local sequenceName = args[1]
                
                table.insert(sequenceHistory, {
                    Sequence = sequenceName,
                    Time = tick(),
                    Args = args
                })
                
                if #sequenceHistory > 10 then
                    table.remove(sequenceHistory, 1)
                end
                
                currentSequence = sequenceName
                lastSequenceTime = tick()
                
                if autoForgeEnabled then
                    print("Detected:", sequenceName)
                end
            end
            
            return result
        end
        
        return true
    end)
    return false
end

-- ðŸ”° Auto Forge Loop
local function startAutoForgeLoop()
    if autoForgeEnabled then return end
    autoForgeEnabled = true
    
    forgeThread = task.spawn(function()
        while autoForgeEnabled do
            if currentSequence ~= "Melt" then
                task.wait(0.5)
                goto continue
            end
            
            if tick() - lastSequenceTime < 2 then
                isProcessing = true
                
                local sequenceOrder = {"Pour", "Hammer", "Water"}
                local delays = {2, 3, 2}
                
                for i, seq in ipairs(sequenceOrder) do
                    if not autoForgeEnabled then break end
                    
                    task.wait(delays[i])
                    
                    if autoForgeEnabled then
                        executeNextSequence(currentSequence)
                    end
                end
                
                isProcessing = false
                currentSequence = "Idle"
            end
            
            ::continue::
            task.wait(0.1)
        end
    end)
end

local function stopAutoForgeLoop()
    autoForgeEnabled = false
    isProcessing = false
    if forgeThread then
        task.cancel(forgeThread)
    end
end

-- ðŸ”° Manual execute sequences
local function executeAllSequences()
    if autoForgeEnabled then
        return
    end
    
    task.spawn(function()
        local sequences = {"Melt", "Pour", "Hammer", "Water"}
        
        for _, seq in ipairs(sequences) do
            local args
            if seq == "Melt" then
                args = {
                    "Melt",
                    {
                        FastForge = false,
                        ItemType = "",
                        Ores = {}
                    }
                }
            else
                args = {
                    seq,
                    {
                        ClientTime = tick()
                    }
                }
            end
            
            pcall(function()
                getForgeRF():InvokeServer(unpack(args))
            end)
            
            if seq ~= "Water" then
                task.wait(2)
            end
        end
    end)
end

-- ðŸ”° Setup GUI
local MainTab = ForgeAutomation:CreateTab({
    Name = "Main Controls"
})

local ControlSection = MainTab:CreateSection({
    Name = "Sequence Control"
})

ControlSection:AddToggle({
    Name = "Enable Auto Sequence",
    Value = false,
    Callback = function(value)
        if value then
            startAutoForgeLoop()
        else
            stopAutoForgeLoop()
        end
    end
})

ControlSection:AddButton({
    Name = "Execute All Sequences Now",
    Callback = executeAllSequences
})

-- ðŸ”° Mobile Settings
local MobileSection = MainTab:CreateSection({
    Name = "Mobile Settings",
    Side = "Right"
})

MobileSection:AddToggle({
    Name = "Enable Mobile Toggle Button",
    Value = true,
    Callback = toggleMobileButton
})

-- ðŸ”° Initialize
task.spawn(function()
    task.wait(2)
    setupHook()
    isMobile = checkIfMobile()
    
    if isMobile and mobileToggleEnabled then
        createMobileToggleButton()
        ForgeAutomation:Hide()
        guiVisible = false
    end
end)

-- ðŸ”° Cleanup
game:GetService("Players").LocalPlayer.CharacterRemoving:Connect(function()
    if autoForgeEnabled then
        stopAutoForgeLoop()
    end
    pcall(function()
        if mobileToggleButton and mobileToggleButton.Parent then
            mobileToggleButton.Parent:Destroy()
        end
    end)
end)

print("Forge Automation Loaded!")
