-- ‚öôÔ∏è Forge Automation - Auto Sequence Detector
local library = loadstring(game:GetObjects("rbxassetid://7657867786")[1].Source)()
local Wait = library.subs.Wait

-- üî∞ Anti-AFK System
local VirtualUser = game:GetService("VirtualUser")
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- üî∞ Window utama
local ForgeAutomation = library:CreateWindow({
    Name = "Forge Sequence Automation",
    Themeable = {
        Info = "Auto Detect & Execute Forge Sequences\nPress RightShift to toggle"
    }
})

-- üî∞ Variables
local autoForgeEnabled = false
local forgeThread = nil
local currentSequence = "Idle"
local isProcessing = false

-- üî∞ Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- üî∞ Remote Function
local ForgeRF
local function getForgeRF()
    if not ForgeRF then
        ForgeRF = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Packages")
            :WaitForChild("Knit"):WaitForChild("Services"):WaitForChild("ForgeService")
            :WaitForChild("RF"):WaitForChild("ChangeSequence")
    end
    return ForgeRF
end

-- üî∞ Sequence detector
local sequencePatterns = {
    Melt = {
        SequenceName = "Melt",
        FastForge = false,
        ItemType = "",
        Ores = {}
    },
    Pour = {
        SequenceName = "Pour",
        ClientTime = tick()
    },
    Hammer = {
        SequenceName = "Hammer",
        ClientTime = tick()
    },
    Water = {
        SequenceName = "Water",
        ClientTime = tick()
    }
}

-- üî∞ Hook untuk mendeteksi sequence yang dipanggil
local originalFireServer
local sequenceHistory = {}
local lastSequenceTime = 0

local function setupHook()
    local forgeRF = getForgeRF()
    
    if not forgeRF then
        print("‚ùå Cannot find ForgeService RF")
        return false
    end
    
    originalFireServer = originalFireServer or forgeRF.InvokeServer
    
    forgeRF.InvokeServer = function(self, ...)
        local args = {...}
        local result = originalFireServer(self, ...)
        
        -- Deteksi sequence yang dipanggil
        if #args >= 1 then
            local sequenceName = args[1]
            
            -- Simpan ke history
            table.insert(sequenceHistory, {
                Sequence = sequenceName,
                Time = tick(),
                Args = args
            })
            
            -- Keep only last 10 entries
            if #sequenceHistory > 10 then
                table.remove(sequenceHistory, 1)
            end
            
            -- Update current sequence
            currentSequence = sequenceName
            lastSequenceTime = tick()
            
            -- Print debug info
            if autoForgeEnabled then
                print("üì° Detected sequence:", sequenceName, "at", tick())
            end
        end
        
        return result
    end
    
    print("‚úÖ Hook setup successful")
    return true
end

-- üî∞ Execute next sequence
local function executeNextSequence(currentSeq)
    local nextSequenceMap = {
        Melt = "Pour",
        Pour = "Hammer",
        Hammer = "Water",
        Water = "Melt"  -- Loop back to start
    }
    
    local nextSeq = nextSequenceMap[currentSeq]
    if not nextSeq then
        print("‚ùå Unknown sequence:", currentSeq)
        return false
    end
    
    -- Buat args berdasarkan sequence
    local args
    if nextSeq == "Melt" then
        args = {
            "Melt",
            {
                FastForge = false,
                ItemType = "",
                Ores = {}
            }
        }
    else
        args = {
            nextSeq,
            {
                ClientTime = tick()
            }
        }
    end
    
    -- Execute sequence
    local success, err = pcall(function()
        getForgeRF():InvokeServer(unpack(args))
    end)
    
    if success then
        print("‚úÖ Executed:", nextSeq)
        currentSequence = nextSeq
        lastSequenceTime = tick()
        return true
    else
        print("‚ùå Failed to execute", nextSeq, ":", err)
        return false
    end
end

-- üî∞ Auto Forge Loop
local function startAutoForgeLoop()
    if autoForgeEnabled then return end
    autoForgeEnabled = true
    
    print("üöÄ Starting Auto Forge Sequence")
    print("üì° Waiting for first Melt sequence...")
    
    forgeThread = task.spawn(function()
        while autoForgeEnabled do
            -- Tunggu deteksi sequence Melt
            if currentSequence ~= "Melt" then
                task.wait(0.5)
                goto continue
            end
            
            -- Jika baru detect Melt, tunggu sebentar lalu execute next sequences
            if tick() - lastSequenceTime < 2 then  -- Sequence baru terdeteksi
                isProcessing = true
                
                -- Urutan sequence setelah Melt
                local sequenceOrder = {"Pour", "Hammer", "Water"}
                
                for _, seq in ipairs(sequenceOrder) do
                    if not autoForgeEnabled then break end
                    
                    -- Tunggu delay antar sequence
                    local delay = seq == "Pour" and 2 or  -- Tunggu 2 detik setelah Melt
                                 seq == "Hammer" and 3 or -- Tunggu 3 detik setelah Pour
                                 seq == "Water" and 2     -- Tunggu 2 detik setelah Hammer
                    
                    print("‚è≥ Waiting", delay, "seconds before", seq)
                    for i = 1, delay do
                        if not autoForgeEnabled then break end
                        task.wait(1)
                    end
                    
                    -- Execute sequence
                    if autoForgeEnabled then
                        executeNextSequence(currentSequence)
                    end
                end
                
                -- Setelah selesai, reset untuk loop berikutnya
                isProcessing = false
                currentSequence = "Idle"
                
                -- Tunggu sebelum loop lagi
                if autoForgeEnabled then
                    print("üîÑ Cycle completed. Waiting for next Melt...")
                end
            end
            
            ::continue::
            task.wait(0.1)
        end
    end)
    
    library:Notify({
        Title = "Forge Automation",
        Content = "Auto Sequence started!\nStart forging in game",
        Duration = 5
    })
end

local function stopAutoForgeLoop()
    autoForgeEnabled = false
    isProcessing = false
    if forgeThread then
        task.cancel(forgeThread)
    end
    print("üõë Auto Forge stopped!")
    library:Notify({
        Title = "Forge Automation",
        Content = "Auto Sequence stopped!",
        Duration = 3
    })
end

-- üî∞ Manual execute sequences
local function executeAllSequences()
    if autoForgeEnabled then
        print("‚ùå Stop auto forge first!")
        library:Notify({
            Title = "Forge Automation",
            Content = "Please stop auto forge first!",
            Duration = 3
        })
        return
    end
    
    print("üî® Executing all sequences manually...")
    
    local sequences = {"Melt", "Pour", "Hammer", "Water"}
    local delays = {2, 3, 2, 0}  -- Delays between sequences
    
    task.spawn(function()
        for i, seq in ipairs(sequences) do
            local args
            if seq == "Melt" then
                args = {
                    "Melt",
                    {
                        FastForge = false,
                        ItemType = "",
                        Ores = {}
                    }
                }
            else
                args = {
                    seq,
                    {
                        ClientTime = tick()
                    }
                }
            end
            
            local success, err = pcall(function()
                getForgeRF():InvokeServer(unpack(args))
            end)
            
            if success then
                print("‚úÖ Executed:", seq)
            else
                print("‚ùå Failed to execute", seq, ":", err)
                break
            end
            
            -- Tunggu delay kecuali sequence terakhir
            if i < #sequences then
                task.wait(delays[i])
            end
        end
        
        print("‚úÖ All sequences executed!")
        library:Notify({
            Title = "Forge Automation",
            Content = "All sequences executed!",
            Duration = 3
        })
    end)
end

-- üî∞ Setup GUI Tabs
local MainTab = ForgeAutomation:CreateTab({
    Name = "Main Controls"
})

local ControlSection = MainTab:CreateSection({
    Name = "Sequence Control"
})

ControlSection:AddToggle({
    Name = "Enable Auto Sequence",
    Value = false,
    Flag = "AutoSequence_Enabled",
    Callback = function(value)
        if value then
            startAutoForgeLoop()
        else
            stopAutoForgeLoop()
        end
    end
})

ControlSection:AddButton({
    Name = "Execute All Sequences Now",
    Callback = function()
        executeAllSequences()
    end
})

ControlSection:AddLabel({
    Text = "Status: Idle",
    Flag = "Status_Label"
})

ControlSection:AddLabel({
    Text = "Current Sequence: None",
    Flag = "Sequence_Label"
})

ControlSection:AddDivider()

ControlSection:AddLabel({
    Text = "Instructions:",
    Flag = "Instructions_Title"
})

ControlSection:AddLabel({
    Text = "1. Start forge in game normally",
    Flag = "Step1"
})

ControlSection:AddLabel({
    Text = "2. Script will detect first Melt",
    Flag = "Step2"
})

ControlSection:AddLabel({
    Text = "3. Then auto execute sequences",
    Flag = "Step3"
})

-- üî∞ Settings Tab
local SettingsTab = ForgeAutomation:CreateTab({
    Name = "Settings"
})

local SettingsSection = SettingsTab:CreateSection({
    Name = "Sequence Settings"
})

SettingsSection:AddSlider({
    Name = "Melt to Pour Delay",
    Flag = "Delay1",
    Value = 2,
    Min = 1,
    Max = 5,
    Format = function(Value)
        return tostring(Value) .. " seconds"
    end
})

SettingsSection:AddSlider({
    Name = "Pour to Hammer Delay",
    Flag = "Delay2",
    Value = 3,
    Min = 1,
    Max = 5,
    Format = function(Value)
        return tostring(Value) .. " seconds"
    end
})

SettingsSection:AddSlider({
    Name = "Hammer to Water Delay",
    Flag = "Delay3",
    Value = 2,
    Min = 1,
    Max = 5,
    Format = function(Value)
        return tostring(Value) .. " seconds"
    end
})

-- üî∞ Debug Tab
local DebugTab = ForgeAutomation:CreateTab({
    Name = "Debug"
})

local DebugSection = DebugTab:CreateSection({
    Name = "Debug Tools"
})

DebugSection:AddButton({
    Name = "Test Connection",
    Callback = function()
        local rf = getForgeRF()
        if rf then
            print("‚úÖ Forge RF found:", rf:GetFullName())
            library:Notify({
                Title = "Connection Test",
                Content = "Forge service connected!",
                Duration = 3
            })
        else
            print("‚ùå Forge RF not found")
        end
    end
})

DebugSection:AddToggle({
    Name = "Show Sequence Logs",
    Value = true,
    Flag = "ShowLogs",
    Callback = function(value)
        print("üìä Sequence logs:", value and "Enabled" or "Disabled")
    end
})

DebugSection:AddButton({
    Name = "Clear History",
    Callback = function()
        sequenceHistory = {}
        print("üßπ Sequence history cleared")
    end
})

DebugSection:AddLabel({
    Text = "Last 5 Sequences:",
    Flag = "History_Label"
})

-- üî∞ Update GUI function
local function updateGUI()
    local statusText = autoForgeEnabled and "Running" or "Stopped"
    local sequenceText = currentSequence
    
    if ForgeAutomation.Flags.Status_Label then
        ForgeAutomation.Flags.Status_Label = "Status: " .. statusText
    end
    
    if ForgeAutomation.Flags.Sequence_Label then
        ForgeAutomation.Flags.Sequence_Label = "Current Sequence: " .. sequenceText
    end
    
    -- Update history display
    if ForgeAutomation.Flags.History_Label then
        local historyText = "Last Sequences:\n"
        for i = math.max(1, #sequenceHistory - 4), #sequenceHistory do
            local entry = sequenceHistory[i]
            if entry then
                local timeAgo = math.floor(tick() - entry.Time)
                historyText = historyText .. string.format("%s (%ds ago)\n", entry.Sequence, timeAgo)
            end
        end
        ForgeAutomation.Flags.History_Label = historyText
    end
end

-- üî∞ Auto update GUI
task.spawn(function()
    while Wait() do
        updateGUI()
        Wait(0.5)
    end
end)

-- üî∞ Initialize hook
task.spawn(function()
    task.wait(2)
    print("üîß Setting up sequence detector...")
    local hooked = setupHook()
    
    if hooked then
        print("‚úÖ Ready! Start forging in game")
        library:Notify({
            Title = "Forge Automation",
            Content = "Sequence detector ready!\nStart forging normally",
            Duration = 5
        })
    else
        print("‚ùå Failed to setup hook")
        library:Notify({
            Title = "Error",
            Content = "Failed to setup sequence detector",
            Duration = 5
        })
    end
end)

-- üî∞ Set keybind
library:SetKeybind("RightShift")

-- üî∞ Print info
print("====================================")
print("üî® FORGE SEQUENCE AUTOMATION")
print("====================================")
print("üì° This script will:")
print("1. Detect when you start forging (Melt)")
print("2. Auto execute Pour, Hammer, Water")
print("3. Wait for next Melt cycle")
print("====================================")
print("üîß Press RightShift for GUI")
print("üëâ Start forging normally in game")
print("====================================")

-- üî∞ Designer
ForgeAutomation:CreateDesigner({
    Info = {
        "Auto Sequence Forge System",
        "Detects first Melt sequence",
        "Then auto completes the cycle",
        "No manual sequence clicking needed"
    },
    Credit = true
})

-- üî∞ Cleanup
game:GetService("Players").LocalPlayer.CharacterRemoving:Connect(function()
    if autoForgeEnabled then
        stopAutoForgeLoop()
    end
    print("üßπ Script cleaned up")
end)
