-- ‚öôÔ∏è Forge Automation Script dengan Library v0.32
local library = loadstring(game:GetObjects("rbxassetid://7657867786")[1].Source)()
local Wait = library.subs.Wait

-- üî∞ Anti-AFK System
local VirtualUser = game:GetService("VirtualUser")
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- üî∞ Buat Window utama
local ForgeAutomation = library:CreateWindow({
    Name = "Forge Automation",
    Themeable = {
        Info = "Auto Forge System v2.0\nPress RightShift to toggle"
    }
})

-- üî∞ Variabel untuk sistem forge
local forgeActive = false
local autoForgeEnabled = false
local forgeThread = nil
local selectedOres = {"Iron", "Copper"}
local selectedItemType = "Sword"
local forgeDelay = 60
local consecutiveFailures = 0
local maxFailures = 3
local statusText = "Stopped"

-- üî∞ Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

-- üî∞ Services Knit
local ForgeController
local ForgeService

-- üî∞ Tunggu Knit services
local function waitForKnitServices()
    local startTime = tick()
    while tick() - startTime < 30 do
        local success, result = pcall(function()
            local Knit = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Packages").Knit)
            if Knit.IsReady then
                ForgeController = Knit.GetController("ForgeController")
                ForgeService = Knit.GetService("ForgeService")
                return ForgeController ~= nil and ForgeService ~= nil
            end
            return false
        end)
        
        if success and result then
            return true
        end
        task.wait(1)
    end
    return false
end

-- üî∞ Fungsi untuk mendapatkan ores yang tersedia
local function getAvailableOres()
    return {"Iron", "Copper", "Silver", "Gold", "Bronze", "Steel", "Mithril", "Adamantite", "Titanium", "Platinum"}
end

-- üî∞ Fungsi untuk memulai forge process
local function startForgeProcess()
    if not ForgeController then
        local servicesReady = waitForKnitServices()
        if not servicesReady then
            print("‚ùå Forge services not available!")
            return false
        end
    end

    -- Cari forge station
    local forgeStation
    local possibleLocations = {
        workspace:FindFirstChild("Proximity") and workspace.Proximity:FindFirstChild("Forge"),
        workspace:FindFirstChild("Forge"),
        workspace:FindFirstChild("Blacksmith"),
        workspace:FindFirstChild("Workshop"),
        workspace:FindFirstChild("Furnace")
    }
    
    for _, location in ipairs(possibleLocations) do
        if location then
            forgeStation = location
            break
        end
    end
    
    if not forgeStation then
        print("‚ùå Forge station not found!")
        return false
    end

    -- Pastikan player character ada
    local character = LocalPlayer.Character
    if not character then
        print("‚ùå Player character not found!")
        return false
    end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then
        print("‚ùå HumanoidRootPart not found!")
        return false
    end

    -- Teleport ke forge station
    humanoidRootPart.CFrame = forgeStation.CFrame + Vector3.new(0, 0, -5)
    task.wait(1)

    -- Cari dan aktifkan proximity prompt
    local prompt = forgeStation:FindFirstChildOfClass("ProximityPrompt")
    if prompt then
        prompt.Enabled = true
        task.wait(0.5)
        fireproximityprompt(prompt)
        print("‚úÖ Activated forge station")
        task.wait(2)
        return true
    else
        print("‚ùå No ProximityPrompt found on forge station!")
        return false
    end
end

-- üî∞ Fungsi untuk forging sequence dengan error handling
local function executeForgingSequence()
    local success, errorMsg = pcall(function()
        -- Start forge process
        if not startForgeProcess() then
            return false, "Failed to start forge process"
        end

        -- Tunggu ForgeController aktif
        local startTime = tick()
        while tick() - startTime < 10 do
            if ForgeController and ForgeController.ForgeActive then
                break
            end
            task.wait(0.5)
        end

        if not ForgeController.ForgeActive then
            return false, "ForgeController not active"
        end

        -- Set data forging
        ForgeController.Ores = selectedOres
        ForgeController.ItemType = selectedItemType

        -- Execute sequences
        local sequences = {"OreSelect", "Melt", "Pour", "Hammer", "Water", "Showcase"}
        
        for _, sequence in ipairs(sequences) do
            if not autoForgeEnabled then break end
            
            print("üéØ Starting sequence: " .. sequence)
            
            local seqSuccess, seqError = pcall(function()
                ForgeController:ChangeSequence(sequence)
            end)
            
            if not seqSuccess then
                print("‚ö†Ô∏è Error in sequence " .. sequence .. ": " .. tostring(seqError))
            end
            
            -- Tunggu antara sequences
            local waitTime = sequence == "Melt" and 10 or 
                            sequence == "Hammer" and 8 or 
                            sequence == "Water" and 5 or 3
                            
            for i = 1, waitTime do
                if not autoForgeEnabled then break end
                task.wait(1)
            end
        end

        return true, "Forging completed successfully"
    end)

    if not success then
        return false, "Forging error: " .. tostring(errorMsg)
    end
    
    return success, errorMsg
end

-- üî∞ Auto Forge Loop
local function startAutoForgeLoop()
    if autoForgeEnabled then return end
    autoForgeEnabled = true
    consecutiveFailures = 0
    statusText = "Running"
    
    forgeThread = task.spawn(function()
        while autoForgeEnabled do
            local success, message = executeForgingSequence()
            
            if success then
                consecutiveFailures = 0
                print("‚úÖ " .. message .. ", waiting " .. forgeDelay .. " seconds...")
                
                -- Tunggu untuk next cycle
                for i = forgeDelay, 1, -1 do
                    if not autoForgeEnabled then break end
                    task.wait(1)
                end
            else
                consecutiveFailures = consecutiveFailures + 1
                print("‚ùå Forging failed: " .. tostring(message))
                
                if consecutiveFailures >= maxFailures then
                    print("‚ùå Too many failures! Auto Forge stopped.")
                    stopAutoForgeLoop()
                    break
                end
                
                -- Tunggu sebelum retry
                local retryDelay = math.min(10 * consecutiveFailures, 30)
                print("‚è≥ Retrying in " .. retryDelay .. " seconds...")
                task.wait(retryDelay)
            end
        end
    end)
    
    print("üöÄ Auto Forge started!")
    library:Notify({
        Title = "Forge Automation",
        Content = "Auto Forge started!",
        Duration = 3
    })
end

local function stopAutoForgeLoop()
    autoForgeEnabled = false
    consecutiveFailures = 0
    statusText = "Stopped"
    if forgeThread then
        task.cancel(forgeThread)
    end
    print("üõë Auto Forge stopped!")
    library:Notify({
        Title = "Forge Automation",
        Content = "Auto Forge stopped!",
        Duration = 3
    })
end

-- üî∞ Manual Forge
local function executeManualForge()
    if autoForgeEnabled then
        library:Notify({
            Title = "Forge Automation",
            Content = "Please stop auto forge first!",
            Duration = 3
        })
        return
    end
    
    task.spawn(function()
        local success, message = executeForgingSequence()
        if success then
            library:Notify({
                Title = "Forge Automation",
                Content = "Manual forging completed!",
                Duration = 3
            })
        else
            library:Notify({
                Title = "Forge Automation",
                Content = "Manual forging failed: " .. tostring(message),
                Duration = 5
            })
        end
    end)
end

-- üî∞ Buat Tab General
local GeneralTab = ForgeAutomation:CreateTab({
    Name = "General"
})

-- üî∞ Auto Forge Section
local AutoForgeSection = GeneralTab:CreateSection({
    Name = "Auto Forge"
})

AutoForgeSection:AddToggle({
    Name = "Enable Auto Forge",
    Value = false,
    Flag = "AutoForge_Enabled",
    Callback = function(value)
        if value then
            startAutoForgeLoop()
        else
            stopAutoForgeLoop()
        end
    end
})

AutoForgeSection:AddButton({
    Name = "Manual Forge Now",
    Callback = function()
        executeManualForge()
    end
})

AutoForgeSection:AddLabel({
    Text = "Status: Stopped",
    Flag = "AutoForge_Status"
})

AutoForgeSection:AddSlider({
    Name = "Forge Delay",
    Flag = "AutoForge_Delay",
    Value = 60,
    Precise = 0,
    Min = 30,
    Max = 300,
    Format = function(Value)
        return "Delay: " .. tostring(Value) .. "s"
    end,
    Callback = function(value)
        forgeDelay = value
        print("‚úÖ Forge delay set to: " .. forgeDelay .. " seconds")
    end
})

AutoForgeSection:AddSlider({
    Name = "Max Failures",
    Flag = "AutoForge_MaxFailures",
    Value = 3,
    Min = 1,
    Max = 10,
    Format = function(Value)
        return "Max Failures: " .. tostring(Value)
    end,
    Callback = function(value)
        maxFailures = value
        print("‚úÖ Max failures set to: " .. maxFailures)
    end
})

-- üî∞ Ore Selection Section
local OreSection = GeneralTab:CreateSection({
    Name = "Ore Selection",
    Side = "Right"
})

-- Simpan referensi ke dropdown untuk update manual
local oreDropdown
local oreDropdownFlag = "OreSelection_Ores"

-- Fungsi untuk mendapatkan ores dari game (placeholder)
local function updateOreList()
    local availableOres = getAvailableOres()
    
    -- Update dropdown jika sudah ada
    if oreDropdown then
        oreDropdown:UpdateList(availableOres)
    end
    
    return availableOres
end

-- Dropdown untuk select ores
local oreList = updateOreList()
oreDropdown = OreSection:AddDropdown({
    Name = "Select Ores",
    Value = {"Iron", "Copper"},
    Callback = function(value)
        selectedOres = value
        print("‚úÖ Selected ores: " .. table.concat(selectedOres, ", "))
    end,
    Flag = oreDropdownFlag,
    Multi = true,
    List = oreList
})

-- Button untuk refresh ore list
OreSection:AddButton({
    Name = "Refresh Ore List",
    Callback = function()
        updateOreList()
        library:Notify({
            Title = "Ore Selection",
            Content = "Ore list refreshed!",
            Duration = 3
        })
    end
})

-- üî∞ Item Type Section
local ItemSection = GeneralTab:CreateSection({
    Name = "Item Type"
})

ItemSection:AddDropdown({
    Name = "Item Type",
    Value = "Sword",
    Callback = function(value)
        selectedItemType = value
        print("‚úÖ Selected item type: " .. selectedItemType)
    end,
    Flag = "ItemType_Type",
    List = {"Sword", "Axe", "Dagger", "Hammer", "Armor", "Shield", "Spear", "Bow", "Mace"}
})

-- üî∞ Status Tab
local StatusTab = ForgeAutomation:CreateTab({
    Name = "Status"
})

local StatusSection = StatusTab:CreateSection({
    Name = "Current Status"
})

StatusSection:AddLabel({
    Text = "Auto Forge: Stopped",
    Flag = "Status_AutoForge"
})

StatusSection:AddLabel({
    Text = "Selected Ores: Iron, Copper",
    Flag = "Status_Ores"
})

StatusSection:AddLabel({
    Text = "Item Type: Sword",
    Flag = "Status_ItemType"
})

StatusSection:AddLabel({
    Text = "Consecutive Failures: 0",
    Flag = "Status_Failures"
})

StatusSection:AddLabel({
    Text = "Forge Delay: 60s",
    Flag = "Status_Delay"
})

StatusSection:AddButton({
    Name = "Refresh Status",
    Callback = function()
        print("üîÑ Status refreshed!")
        library:Notify({
            Title = "Status",
            Content = "Status refreshed!",
            Duration = 2
        })
    end
})

-- üî∞ Settings Tab
local SettingsTab = ForgeAutomation:CreateTab({
    Name = "Settings"
})

local ConfigSection = SettingsTab:CreateSection({
    Name = "Configuration"
})

ConfigSection:AddButton({
    Name = "Save Configuration",
    Callback = function()
        library:Notify({
            Title = "Configuration",
            Content = "Configuration saved!",
            Duration = 3
        })
        print("‚úÖ Configuration saved!")
    end
})

ConfigSection:AddButton({
    Name = "Load Configuration",
    Callback = function()
        library:Notify({
            Title = "Configuration",
            Content = "Configuration loaded!",
            Duration = 3
        })
        print("‚úÖ Configuration loaded!")
    end
})

local ResetSection = SettingsTab:CreateSection({
    Name = "Reset",
    Side = "Right"
})

ResetSection:AddButton({
    Name = "Reset to Defaults",
    Callback = function()
        -- Reset variables
        selectedOres = {"Iron", "Copper"}
        selectedItemType = "Sword"
        forgeDelay = 60
        maxFailures = 3
        
        -- Reset UI flags
        ForgeAutomation.Flags.AutoForge_Enabled = false
        ForgeAutomation.Flags.AutoForge_Delay = 60
        ForgeAutomation.Flags.AutoForge_MaxFailures = 3
        ForgeAutomation.Flags[oreDropdownFlag] = {"Iron", "Copper"}
        ForgeAutomation.Flags.ItemType_Type = "Sword"
        
        -- Stop auto forge jika sedang berjalan
        if autoForgeEnabled then
            stopAutoForgeLoop()
        end
        
        library:Notify({
            Title = "Reset",
            Content = "Reset to defaults successful!",
            Duration = 3
        })
        print("‚úÖ Reset to defaults!")
    end
})

-- üî∞ Debug Tab (untuk testing)
local DebugTab = ForgeAutomation:CreateTab({
    Name = "Debug"
})

local DebugSection = DebugTab:CreateSection({
    Name = "Debug Tools"
})

DebugSection:AddButton({
    Name = "Test Forge Sequence",
    Callback = function()
        print("üß™ Testing forge sequence...")
        executeManualForge()
    end
})

DebugSection:AddButton({
    Name = "Check Services",
    Callback = function()
        local servicesReady = waitForKnitServices()
        if servicesReady then
            library:Notify({
                Title = "Debug",
                Content = "Forge services: READY",
                Duration = 3
            })
            print("‚úÖ Forge services: READY")
        else
            library:Notify({
                Title = "Debug",
                Content = "Forge services: NOT FOUND",
                Duration = 3
            })
            print("‚ùå Forge services: NOT FOUND")
        end
    end
})

DebugSection:AddToggle({
    Name = "Debug Mode",
    Value = false,
    Flag = "Debug_Mode",
    Callback = function(value)
        if value then
            print("üîß Debug mode enabled")
        else
            print("üîß Debug mode disabled")
        end
    end
})

-- üî∞ Update status function
local function updateStatus()
    local autoForgeStatus = autoForgeEnabled and "Running" or "Stopped"
    local oresText = #selectedOres > 0 and table.concat(selectedOres, ", ") or "None"
    
    -- Update status labels
    if ForgeAutomation.Flags.AutoForge_Status then
        ForgeAutomation.Flags.AutoForge_Status = "Status: " .. autoForgeStatus
    end
    
    if ForgeAutomation.Flags.Status_AutoForge then
        ForgeAutomation.Flags.Status_AutoForge = "Auto Forge: " .. autoForgeStatus
    end
    
    if ForgeAutomation.Flags.Status_Ores then
        ForgeAutomation.Flags.Status_Ores = "Selected Ores: " .. oresText
    end
    
    if ForgeAutomation.Flags.Status_ItemType then
        ForgeAutomation.Flags.Status_ItemType = "Item Type: " .. selectedItemType
    end
    
    if ForgeAutomation.Flags.Status_Failures then
        ForgeAutomation.Flags.Status_Failures = "Consecutive Failures: " .. tostring(consecutiveFailures)
    end
    
    if ForgeAutomation.Flags.Status_Delay then
        ForgeAutomation.Flags.Status_Delay = "Forge Delay: " .. tostring(forgeDelay) .. "s"
    end
end

-- üî∞ Auto update status
task.spawn(function()
    while Wait() do
        updateStatus()
        Wait(1)
    end
end)

-- üî∞ Auto-initialize services
task.spawn(function()
    print("üîÑ Waiting for forge services...")
    local servicesReady = waitForKnitServices()
    if servicesReady then
        print("‚úÖ Forge services initialized successfully!")
        
        -- Update status setelah services ready
        updateStatus()
        
        library:Notify({
            Title = "Forge Automation",
            Content = "Services initialized successfully!",
            Duration = 3
        })
    else
        print("‚ùå Failed to initialize forge services!")
        
        -- Update error status
        if ForgeAutomation.Flags.Status_AutoForge then
            ForgeAutomation.Flags.Status_AutoForge = "Auto Forge: ERROR - Services not found"
        end
        
        library:Notify({
            Title = "Forge Automation",
            Content = "Failed to initialize forge services!",
            Duration = 5
        })
    end
end)

-- üî∞ Set keybind untuk toggle GUI
library:SetKeybind("RightShift")

-- üî∞ Print welcome message
print("====================================")
print("üî® Forge Automation System v2.0")
print("üîß Press RightShift to open/close GUI")
print("üéØ Auto-initializing forge services...")
print("====================================")

-- üî∞ Designer untuk customisasi GUI
ForgeAutomation:CreateDesigner({
    Info = {
        "Forge Automation System v2.0",
        "Auto Forge with error handling",
        "Multiple ore selection",
        "Real-time status monitoring"
    },
    Credit = true
})

-- üî∞ Notifikasi ketika script loaded
task.wait(2)
library:Notify({
    Title = "Forge Automation",
    Content = "Script loaded successfully!",
    Duration = 5
})

-- üî∞ Cleanup ketika script di-unload
library.signals:connection(game:GetService("Players").LocalPlayer.CharacterRemoving, function()
    if autoForgeEnabled then
        stopAutoForgeLoop()
    end
    print("üßπ Cleaning up forge automation...")
end)
