-- ‚öôÔ∏è Forge Automation - Auto Sequence Detector with Mobile GUI
local library = loadstring(game:GetObjects("rbxassetid://7657867786")[1].Source)()
local Wait = library.subs.Wait

-- üî∞ Anti-AFK System
local VirtualUser = game:GetService("VirtualUser")
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- üî∞ Create GUI using existing template
local ForgeAutomation = library:CreateWindow({
    Name = "Forge Automation",
    Themeable = {
        Info = "Auto Sequence Forge System\nPress RightShift to toggle GUI"
    }
})

-- üî∞ Variables
local autoForgeEnabled = false
local forgeThread = nil
local currentSequence = "Idle"
local isProcessing = false

-- üî∞ Mobile GUI Variables
local mobileToggleEnabled = true
local mobileToggleButton = nil
local guiVisible = true
local isMobile = false

-- üî∞ Check if running on mobile
local function checkIfMobile()
    local UIS = game:GetService("UserInputService")
    return UIS.TouchEnabled
end

-- üî∞ Create Mobile Toggle Button
local function createMobileToggleButton()
    -- Cek apakah sudah ada button
    if mobileToggleButton then
        mobileToggleButton.Parent:Destroy()
    end
    
    -- Buat ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ForgeAutoMobileGUI"
    screenGui.Parent = game:GetService("CoreGui")
    screenGui.ResetOnSpawn = false
    
    -- Buat toggle button
    mobileToggleButton = Instance.new("TextButton")
    mobileToggleButton.Name = "MobileToggle"
    mobileToggleButton.Text = "‚öôÔ∏è\nFORGE\nAUTO"
    mobileToggleButton.Font = Enum.Font.GothamBold
    mobileToggleButton.TextSize = 14
    mobileToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    mobileToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    mobileToggleButton.BorderSizePixel = 0
    mobileToggleButton.Size = UDim2.new(0, 70, 0, 70)
    mobileToggleButton.Position = UDim2.new(0.85, 0, 0.15, 0)
    mobileToggleButton.Parent = screenGui
    
    -- Style button
    mobileToggleButton.AutoButtonColor = true
    
    -- Rounded corners
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.2, 0)
    corner.Parent = mobileToggleButton
    
    -- Shadow effect
    local shadow = Instance.new("UIStroke")
    shadow.Color = Color3.fromRGB(100, 100, 150)
    shadow.Thickness = 2
    shadow.Parent = mobileToggleButton
    
    -- Toggle function
    mobileToggleButton.MouseButton1Click:Connect(function()
        guiVisible = not guiVisible
        
        if guiVisible then
            ForgeAutomation:Show()
            mobileToggleButton.Text = "‚öôÔ∏è\nHIDE\nGUI"
            mobileToggleButton.BackgroundColor3 = Color3.fromRGB(40, 100, 200)
        else
            ForgeAutomation:Hide()
            mobileToggleButton.Text = "‚öôÔ∏è\nSHOW\nGUI"
            mobileToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        end
    end)
    
    -- Make draggable
    local dragging = false
    local dragStart, startPos
    
    mobileToggleButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = mobileToggleButton.Position
        end
    end)
    
    mobileToggleButton.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            mobileToggleButton.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X,
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    print("‚úÖ Mobile toggle button created")
end

-- üî∞ Toggle Mobile Button
local function toggleMobileButton(enable)
    mobileToggleEnabled = enable
    
    if enable then
        createMobileToggleButton()
    else
        if mobileToggleButton then
            mobileToggleButton.Parent:Destroy()
            mobileToggleButton = nil
        end
    end
end

-- üî∞ Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- üî∞ Remote Function
local ForgeRF
local function getForgeRF()
    if not ForgeRF then
        ForgeRF = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Packages")
            :WaitForChild("Knit"):WaitForChild("Services"):WaitForChild("ForgeService")
            :WaitForChild("RF"):WaitForChild("ChangeSequence")
    end
    return ForgeRF
end

-- üî∞ Sequence detector
local sequencePatterns = {
    Melt = {
        SequenceName = "Melt",
        FastForge = false,
        ItemType = "",
        Ores = {}
    },
    Pour = {
        SequenceName = "Pour",
        ClientTime = tick()
    },
    Hammer = {
        SequenceName = "Hammer",
        ClientTime = tick()
    },
    Water = {
        SequenceName = "Water",
        ClientTime = tick()
    }
}

-- üî∞ Hook untuk mendeteksi sequence
local originalFireServer
local sequenceHistory = {}
local lastSequenceTime = 0

local function setupHook()
    local forgeRF = getForgeRF()
    
    if not forgeRF then
        print("‚ùå Cannot find ForgeService RF")
        return false
    end
    
    originalFireServer = originalFireServer or forgeRF.InvokeServer
    
    forgeRF.InvokeServer = function(self, ...)
        local args = {...}
        local result = originalFireServer(self, ...)
        
        if #args >= 1 then
            local sequenceName = args[1]
            
            table.insert(sequenceHistory, {
                Sequence = sequenceName,
                Time = tick(),
                Args = args
            })
            
            if #sequenceHistory > 10 then
                table.remove(sequenceHistory, 1)
            end
            
            currentSequence = sequenceName
            lastSequenceTime = tick()
            
            if autoForgeEnabled then
                print("üì° Detected sequence:", sequenceName)
            end
        end
        
        return result
    end
    
    print("‚úÖ Hook setup successful")
    return true
end

-- üî∞ Execute next sequence
local function executeNextSequence(currentSeq)
    local nextSequenceMap = {
        Melt = "Pour",
        Pour = "Hammer",
        Hammer = "Water",
        Water = "Melt"
    }
    
    local nextSeq = nextSequenceMap[currentSeq]
    if not nextSeq then
        return false
    end
    
    local args
    if nextSeq == "Melt" then
        args = {
            "Melt",
            {
                FastForge = false,
                ItemType = "",
                Ores = {}
            }
        }
    else
        args = {
            nextSeq,
            {
                ClientTime = tick()
            }
        }
    end
    
    local success, err = pcall(function()
        getForgeRF():InvokeServer(unpack(args))
    end)
    
    if success then
        print("‚úÖ Executed:", nextSeq)
        currentSequence = nextSeq
        lastSequenceTime = tick()
        return true
    else
        print("‚ùå Failed:", nextSeq, ":", err)
        return false
    end
end

-- üî∞ Auto Forge Loop
local function startAutoForgeLoop()
    if autoForgeEnabled then return end
    autoForgeEnabled = true
    
    print("üöÄ Starting Auto Forge Sequence")
    
    forgeThread = task.spawn(function()
        while autoForgeEnabled do
            if currentSequence ~= "Melt" then
                task.wait(0.5)
                goto continue
            end
            
            if tick() - lastSequenceTime < 2 then
                isProcessing = true
                
                local sequenceOrder = {"Pour", "Hammer", "Water"}
                local delays = {2, 3, 2}
                
                for i, seq in ipairs(sequenceOrder) do
                    if not autoForgeEnabled then break end
                    
                    task.wait(delays[i])
                    
                    if autoForgeEnabled then
                        executeNextSequence(currentSequence)
                    end
                end
                
                isProcessing = false
                currentSequence = "Idle"
                
                if autoForgeEnabled then
                    print("üîÑ Cycle completed")
                end
            end
            
            ::continue::
            task.wait(0.1)
        end
    end)
end

local function stopAutoForgeLoop()
    autoForgeEnabled = false
    isProcessing = false
    if forgeThread then
        task.cancel(forgeThread)
    end
    print("üõë Auto Forge stopped!")
end

-- üî∞ Manual execute sequences
local function executeAllSequences()
    if autoForgeEnabled then
        print("‚ùå Stop auto forge first!")
        return
    end
    
    print("üî® Executing all sequences manually...")
    
    task.spawn(function()
        local sequences = {"Melt", "Pour", "Hammer", "Water"}
        
        for _, seq in ipairs(sequences) do
            local args
            if seq == "Melt" then
                args = {
                    "Melt",
                    {
                        FastForge = false,
                        ItemType = "",
                        Ores = {}
                    }
                }
            else
                args = {
                    seq,
                    {
                        ClientTime = tick()
                    }
                }
            end
            
            pcall(function()
                getForgeRF():InvokeServer(unpack(args))
            end)
            
            if seq ~= "Water" then
                task.wait(2)
            end
        end
        
        print("‚úÖ All sequences executed!")
    end)
end

-- üî∞ Setup GUI Tabs
local MainTab = ForgeAutomation:CreateTab({
    Name = "Main Controls"
})

local ControlSection = MainTab:CreateSection({
    Name = "Sequence Control"
})

ControlSection:AddToggle({
    Name = "Enable Auto Sequence",
    Value = false,
    Flag = "AutoForge_Enabled",
    Callback = function(value)
        if value then
            startAutoForgeLoop()
        else
            stopAutoForgeLoop()
        end
    end
})

ControlSection:AddButton({
    Name = "Execute All Sequences Now",
    Callback = executeAllSequences
})

ControlSection:AddLabel({
    Text = "Status: Stopped",
    Flag = "Status_Label"
})

ControlSection:AddLabel({
    Text = "Current Sequence: None",
    Flag = "Sequence_Label"
})

-- üî∞ Settings Section
local SettingsSection = MainTab:CreateSection({
    Name = "Settings",
    Side = "Right"
})

SettingsSection:AddSlider({
    Name = "Melt to Pour Delay",
    Flag = "Delay1",
    Value = 2,
    Min = 1,
    Max = 5,
    Format = function(Value)
        return tostring(Value) .. " seconds"
    end
})

SettingsSection:AddSlider({
    Name = "Pour to Hammer Delay",
    Flag = "Delay2",
    Value = 3,
    Min = 1,
    Max = 5,
    Format = function(Value)
        return tostring(Value) .. " seconds"
    end
})

SettingsSection:AddSlider({
    Name = "Hammer to Water Delay",
    Flag = "Delay3",
    Value = 2,
    Min = 1,
    Max = 5,
    Format = function(Value)
        return tostring(Value) .. " seconds"
    end
})

-- üî∞ Mobile Section
local MobileSection = MainTab:CreateSection({
    Name = "Mobile Controls"
})

MobileSection:AddToggle({
    Name = "Mobile Toggle Button",
    Value = true,
    Flag = "Mobile_Toggle",
    Callback = function(value)
        toggleMobileButton(value)
    end
})

MobileSection:AddButton({
    Name = "Hide GUI",
    Callback = function()
        ForgeAutomation:Hide()
        guiVisible = false
        if mobileToggleButton then
            mobileToggleButton.Text = "‚öôÔ∏è\nSHOW\nGUI"
            mobileToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        end
    end
})

MobileSection:AddButton({
    Name = "Show GUI",
    Callback = function()
        ForgeAutomation:Show()
        guiVisible = true
        if mobileToggleButton then
            mobileToggleButton.Text = "‚öôÔ∏è\nHIDE\nGUI"
            mobileToggleButton.BackgroundColor3 = Color3.fromRGB(40, 100, 200)
        end
    end
})

-- üî∞ Status Tab
local StatusTab = ForgeAutomation:CreateTab({
    Name = "Status"
})

local StatusSection = StatusTab:CreateSection({
    Name = "Current Status"
})

StatusSection:AddLabel({
    Text = "Auto Forge: Stopped",
    Flag = "Status_AutoForge"
})

StatusSection:AddLabel({
    Text = "Processing: No",
    Flag = "Status_Processing"
})

StatusSection:AddLabel({
    Text = "Last Sequence: None",
    Flag = "Status_LastSequence"
})

StatusSection:AddLabel({
    Text = "Sequence Count: 0",
    Flag = "Status_SequenceCount"
})

-- üî∞ Update GUI function
local function updateGUI()
    local statusText = autoForgeEnabled and "Running" or "Stopped"
    local processingText = isProcessing and "Yes" or "No"
    local lastSeq = #sequenceHistory > 0 and sequenceHistory[#sequenceHistory].Sequence or "None"
    
    if ForgeAutomation.Flags.Status_Label then
        ForgeAutomation.Flags.Status_Label = "Status: " .. statusText
    end
    
    if ForgeAutomation.Flags.Sequence_Label then
        ForgeAutomation.Flags.Sequence_Label = "Current Sequence: " .. currentSequence
    end
    
    if ForgeAutomation.Flags.Status_AutoForge then
        ForgeAutomation.Flags.Status_AutoForge = "Auto Forge: " .. statusText
    end
    
    if ForgeAutomation.Flags.Status_Processing then
        ForgeAutomation.Flags.Status_Processing = "Processing: " .. processingText
    end
    
    if ForgeAutomation.Flags.Status_LastSequence then
        ForgeAutomation.Flags.Status_LastSequence = "Last Sequence: " .. lastSeq
    end
    
    if ForgeAutomation.Flags.Status_SequenceCount then
        ForgeAutomation.Flags.Status_SequenceCount = "Sequence Count: " .. #sequenceHistory
    end
end

-- üî∞ Auto update GUI
task.spawn(function()
    while Wait() do
        updateGUI()
        Wait(0.5)
    end
end)

-- üî∞ Initialize
task.spawn(function()
    task.wait(2)
    print("üîß Setting up sequence detector...")
    setupHook()
    
    isMobile = checkIfMobile()
    if isMobile and mobileToggleEnabled then
        createMobileToggleButton()
        ForgeAutomation:Hide()
        guiVisible = false
        print("üì± Mobile mode activated")
    end
    
    print("‚úÖ Forge Automation Ready!")
end)

-- üî∞ Set keybind untuk PC
library:SetKeybind("RightShift")

-- üî∞ Print info
print("====================================")
print("üî® FORGE SEQUENCE AUTOMATION")
print("====================================")
print("üì° Script Features:")
print("1. Auto detect Melt sequence")
print("2. Auto execute Pour, Hammer, Water")
print("3. Mobile floating button")
print("4. Real-time status updates")
print("====================================")
print("üì± Mobile: Floating toggle button")
print("üíª PC: Press RightShift for GUI")
print("====================================")

-- üî∞ Designer
ForgeAutomation:CreateDesigner({
    Info = {
        "Forge Sequence Automation",
        "Auto detects and completes sequences",
        "Mobile friendly with floating button",
        "Start forging normally in game"
    },
    Credit = true
})

-- üî∞ Cleanup
game:GetService("Players").LocalPlayer.CharacterRemoving:Connect(function()
    if autoForgeEnabled then
        stopAutoForgeLoop()
    end
    if mobileToggleButton then
        mobileToggleButton.Parent:Destroy()
    end
    print("üßπ Script cleaned up")
end)
