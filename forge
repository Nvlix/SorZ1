-- âš™ï¸ Forge Automation Script dengan Library v0.32
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/wally-rblx/LinoriaLib/main/Library.lua"))()

-- ğŸ”° Anti-AFK System
local VirtualUser = game:GetService("VirtualUser")
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- ğŸ”° Buat Window utama
local Window = Library:CreateWindow({
    Name = "Forge Automation v2.0",
    Themeable = {
        Info = "Auto Forge System\nPress RightShift to toggle"
    }
})

-- ğŸ”° Variabel untuk sistem forge
local forgeActive = false
local autoForgeEnabled = false
local forgeThread = nil
local selectedOres = {"Iron", "Copper"}
local selectedItemType = "Sword"
local forgeDelay = 60
local consecutiveFailures = 0
local maxFailures = 3

-- ğŸ”° Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

-- ğŸ”° Services Knit
local ForgeController
local ForgeService

-- ğŸ”° Tunggu Knit services
local function waitForKnitServices()
    local startTime = tick()
    while tick() - startTime < 30 do
        local success, result = pcall(function()
            local Knit = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Packages").Knit)
            if Knit.IsReady then
                ForgeController = Knit.GetController("ForgeController")
                ForgeService = Knit.GetService("ForgeService")
                return ForgeController ~= nil and ForgeService ~= nil
            end
            return false
        end)
        
        if success and result then
            return true
        end
        task.wait(1)
    end
    return false
end

-- ğŸ”° Fungsi untuk mendapatkan ores yang tersedia
local function getAvailableOres()
    return {"Iron", "Copper", "Silver", "Gold", "Bronze", "Steel", "Mithril", "Adamantite", "Titanium", "Platinum"}
end

-- ğŸ”° Fungsi untuk memulai forge process
local function startForgeProcess()
    if not ForgeController then
        local servicesReady = waitForKnitServices()
        if not servicesReady then
            print("âŒ Forge services not available!")
            return false
        end
    end

    -- Cari forge station
    local forgeStation
    local possibleLocations = {
        workspace:FindFirstChild("Proximity") and workspace.Proximity:FindFirstChild("Forge"),
        workspace:FindFirstChild("Forge"),
        workspace:FindFirstChild("Blacksmith"),
        workspace:FindFirstChild("Workshop"),
        workspace:FindFirstChild("Furnace")
    }
    
    for _, location in ipairs(possibleLocations) do
        if location then
            forgeStation = location
            break
        end
    end
    
    if not forgeStation then
        print("âŒ Forge station not found!")
        return false
    end

    -- Pastikan player character ada
    local character = LocalPlayer.Character
    if not character then
        print("âŒ Player character not found!")
        return false
    end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then
        print("âŒ HumanoidRootPart not found!")
        return false
    end

    -- Teleport ke forge station
    humanoidRootPart.CFrame = forgeStation.CFrame + Vector3.new(0, 0, -5)
    task.wait(1)

    -- Cari dan aktifkan proximity prompt
    local prompt = forgeStation:FindFirstChildOfClass("ProximityPrompt")
    if prompt then
        prompt.Enabled = true
        task.wait(0.5)
        fireproximityprompt(prompt)
        print("âœ… Activated forge station")
        task.wait(2)
        return true
    else
        print("âŒ No ProximityPrompt found on forge station!")
        return false
    end
end

-- ğŸ”° Fungsi untuk forging sequence dengan error handling
local function executeForgingSequence()
    local success, errorMsg = pcall(function()
        -- Start forge process
        if not startForgeProcess() then
            return false, "Failed to start forge process"
        end

        -- Tunggu ForgeController aktif
        local startTime = tick()
        while tick() - startTime < 10 do
            if ForgeController and ForgeController.ForgeActive then
                break
            end
            task.wait(0.5)
        end

        if not ForgeController.ForgeActive then
            return false, "ForgeController not active"
        end

        -- Set data forging
        ForgeController.Ores = selectedOres
        ForgeController.ItemType = selectedItemType

        -- Execute sequences
        local sequences = {"OreSelect", "Melt", "Pour", "Hammer", "Water", "Showcase"}
        
        for _, sequence in ipairs(sequences) do
            if not autoForgeEnabled then break end
            
            print("ğŸ¯ Starting sequence: " .. sequence)
            
            local seqSuccess, seqError = pcall(function()
                ForgeController:ChangeSequence(sequence)
            end)
            
            if not seqSuccess then
                print("âš ï¸ Error in sequence " .. sequence .. ": " .. tostring(seqError))
                -- Skip ke sequence berikutnya jika ada error
            end
            
            -- Tunggu antara sequences
            local waitTime = sequence == "Melt" and 10 or 
                            sequence == "Hammer" and 8 or 
                            sequence == "Water" and 5 or 3
                            
            for i = 1, waitTime do
                if not autoForgeEnabled then break end
                task.wait(1)
            end
        end

        return true, "Forging completed successfully"
    end)

    if not success then
        return false, "Forging error: " .. tostring(errorMsg)
    end
    
    return success, errorMsg
end

-- ğŸ”° Auto Forge Loop
local function startAutoForgeLoop()
    if autoForgeEnabled then return end
    autoForgeEnabled = true
    consecutiveFailures = 0
    
    forgeThread = task.spawn(function()
        while autoForgeEnabled do
            local success, message = executeForgingSequence()
            
            if success then
                consecutiveFailures = 0
                print("âœ… " .. message .. ", waiting " .. forgeDelay .. " seconds...")
                
                -- Tunggu untuk next cycle
                for i = forgeDelay, 1, -1 do
                    if not autoForgeEnabled then break end
                    task.wait(1)
                end
            else
                consecutiveFailures = consecutiveFailures + 1
                print("âŒ Forging failed: " .. tostring(message))
                
                if consecutiveFailures >= maxFailures then
                    print("âŒ Too many failures! Auto Forge stopped.")
                    stopAutoForgeLoop()
                    break
                end
                
                -- Tunggu sebelum retry
                local retryDelay = math.min(10 * consecutiveFailures, 30)
                print("â³ Retrying in " .. retryDelay .. " seconds...")
                task.wait(retryDelay)
            end
        end
    end)
    
    print("ğŸš€ Auto Forge started!")
end

local function stopAutoForgeLoop()
    autoForgeEnabled = false
    consecutiveFailures = 0
    if forgeThread then
        task.cancel(forgeThread)
    end
    print("ğŸ›‘ Auto Forge stopped!")
end

-- ğŸ”° Manual Forge
local function executeManualForge()
    if autoForgeEnabled then
        print("âš ï¸ Please stop auto forge first!")
        return
    end
    
    task.spawn(function()
        local success, message = executeForgingSequence()
        if success then
            print("âœ… Manual forging completed!")
        else
            print("âŒ Manual forging failed: " .. tostring(message))
        end
    end)
end

-- ğŸ”° Buat Tab di Window
local MainTab = Window:CreateTab("Main Controls", "rbxassetid://6034509993")

-- ğŸ”° Main Section
local MainSection = MainTab:CreateSection({
    Name = "Forge Controls",
    Side = "Left"
})

-- Toggle Auto Forge
MainSection:AddToggle({
    Name = "Enable Auto Forge",
    Value = false,
    Flag = "AutoForgeToggle",
    Callback = function(value)
        if value then
            startAutoForgeLoop()
        else
            stopAutoForgeLoop()
        end
    end
})

-- Manual Forge Button
MainSection:AddButton({
    Name = "Manual Forge Now",
    Callback = function()
        executeManualForge()
    end
})

-- Status Indicator
MainSection:AddLabel({
    Text = "Status: Stopped",
    Flag = "StatusLabel"
})

-- ğŸ”° Ore Selection Section
local OreSection = MainTab:CreateSection({
    Name = "Ore Selection",
    Side = "Left"
})

-- Dropdown untuk select ores (Multi-select)
OreSection:AddDropdown({
    Name = "Select Ores",
    Value = {"Iron", "Copper"},
    Callback = function(value)
        selectedOres = value
        print("âœ… Selected ores: " .. table.concat(selectedOres, ", "))
    end,
    Flag = "OreSelection",
    Multi = true,
    List = getAvailableOres()
})

-- ğŸ”° Item Type Section
local ItemSection = MainTab:CreateSection({
    Name = "Item Type",
    Side = "Right"
})

-- Dropdown untuk item type
ItemSection:AddDropdown({
    Name = "Item Type",
    Value = "Sword",
    Callback = function(value)
        selectedItemType = value
        print("âœ… Selected item type: " .. selectedItemType)
    end,
    Flag = "ItemType",
    List = {"Sword", "Axe", "Dagger", "Hammer", "Armor", "Shield", "Spear", "Bow", "Mace"}
})

-- ğŸ”° Settings Section
local SettingsSection = MainTab:CreateSection({
    Name = "Settings",
    Side = "Right"
})

-- Slider untuk forge delay
SettingsSection:AddSlider({
    Name = "Forge Delay (seconds)",
    Value = 60,
    Min = 30,
    Max = 300,
    Format = "%s seconds",
    Callback = function(value)
        forgeDelay = value
        print("âœ… Forge delay set to: " .. forgeDelay .. " seconds")
    end,
    Flag = "ForgeDelay"
})

-- Slider untuk max failures
SettingsSection:AddSlider({
    Name = "Max Failures",
    Value = 3,
    Min = 1,
    Max = 10,
    Format = "%s failures",
    Callback = function(value)
        maxFailures = value
        print("âœ… Max failures set to: " .. maxFailures)
    end,
    Flag = "MaxFailures"
})

-- ğŸ”° Status Tab
local StatusTab = Window:CreateTab("Status Monitor", "rbxassetid://6034509993")

local StatusSection = StatusTab:CreateSection({
    Name = "Current Status",
    Side = "Left"
})

-- Status Textboxes
StatusSection:AddTextbox({
    Name = "Auto Forge Status",
    Value = "Stopped",
    Flag = "StatusAutoForge",
    Callback = function() end
})

StatusSection:AddTextbox({
    Name = "Selected Ores",
    Value = "Iron, Copper",
    Flag = "StatusOres",
    Callback = function() end
})

StatusSection:AddTextbox({
    Name = "Item Type",
    Value = "Sword",
    Flag = "StatusItem",
    Callback = function() end
})

StatusSection:AddTextbox({
    Name = "Consecutive Failures",
    Value = "0",
    Flag = "StatusFailures",
    Callback = function() end
})

-- Refresh Button
StatusSection:AddButton({
    Name = "Refresh Status",
    Callback = function()
        print("ğŸ”„ Status refreshed!")
    end
})

-- ğŸ”° Config Tab
local ConfigTab = Window:CreateTab("Configuration", "rbxassetid://6031280882")

local ConfigSection = ConfigTab:CreateSection({
    Name = "Save/Load Config",
    Side = "Left"
})

-- Save Config Button
ConfigSection:AddButton({
    Name = "Save Config",
    Callback = function()
        print("âœ… Config saved!")
        -- Di sini Anda bisa menambahkan kode untuk save config
    end
})

-- Load Config Button
ConfigSection:AddButton({
    Name = "Load Config",
    Callback = function()
        print("âœ… Config loaded!")
        -- Di sini Anda bisa menambahkan kode untuk load config
    end
})

local ResetSection = ConfigTab:CreateSection({
    Name = "Reset",
    Side = "Right"
})

-- Reset Button
ResetSection:AddButton({
    Name = "Reset to Defaults",
    Callback = function()
        selectedOres = {"Iron", "Copper"}
        selectedItemType = "Sword"
        forgeDelay = 60
        maxFailures = 3
        
        -- Update UI elements
        Window.Flags.OreSelection = {"Iron", "Copper"}
        Window.Flags.ItemType = "Sword"
        Window.Flags.ForgeDelay = 60
        Window.Flags.MaxFailures = 3
        
        print("âœ… Reset to defaults!")
    end
})

-- ğŸ”° Update status function
local function updateStatus()
    local autoForgeStatus = autoForgeEnabled and "Running" or "Stopped"
    local oresText = #selectedOres > 0 and table.concat(selectedOres, ", ") or "None"
    
    -- Update status label
    if Window.Flags.StatusLabel then
        Window.Flags.StatusLabel = "Status: " .. autoForgeStatus
    end
    
    -- Update status textboxes
    if Window.Flags.StatusAutoForge then
        Window.Flags.StatusAutoForge = autoForgeStatus
    end
    if Window.Flags.StatusOres then
        Window.Flags.StatusOres = oresText
    end
    if Window.Flags.StatusItem then
        Window.Flags.StatusItem = selectedItemType
    end
    if Window.Flags.StatusFailures then
        Window.Flags.StatusFailures = tostring(consecutiveFailures)
    end
end

-- ğŸ”° Auto update status
task.spawn(function()
    while true do
        updateStatus()
        task.wait(1)
    end
end)

-- ğŸ”° Keybind untuk toggle GUI
Library:SetKeybind("RightShift")

-- ğŸ”° Auto-initialize services
task.spawn(function()
    print("ğŸ”„ Waiting for forge services...")
    local servicesReady = waitForKnitServices()
    if servicesReady then
        print("âœ… Forge services initialized successfully!")
        
        -- Update status setelah services ready
        updateStatus()
    else
        print("âŒ Failed to initialize forge services!")
        
        -- Tampilkan error di status
        if Window.Flags.StatusAutoForge then
            Window.Flags.StatusAutoForge = "Error: Services not found"
        end
    end
end)

-- ğŸ”° Print welcome message
print("====================================")
print("ğŸ”¨ Forge Automation System v2.0")
print("ğŸ”§ Press RightShift to open/close GUI")
print("ğŸ¯ Auto-initializing forge services...")
print("====================================")

-- ğŸ”° Designer untuk customisasi
Window:CreateDesigner({
    Info = {
        "Forge Automation v2.0",
        "Auto Forging System",
        "Supports multiple ore types",
        "Error handling included"
    },
    Credit = true
})

-- ğŸ”° Notifikasi ketika script loaded
Library:Notify({
    Title = "Forge Automation",
    Content = "Script loaded successfully!",
    Duration = 5
})

-- ğŸ”° Debugging function untuk testing
local function testForge()
    print("ğŸ§ª Testing forge system...")
    executeManualForge()
end

-- Tambahkan test button di tab config jika diperlukan
ConfigSection:AddButton({
    Name = "Test Forge (Debug)",
    Callback = testForge
})
