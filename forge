-- ‚öôÔ∏è Forge Automation Script - Auto Run tanpa pemilihan ore
local library = loadstring(game:GetObjects("rbxassetid://7657867786")[1].Source)()
local Wait = library.subs.Wait

-- üî∞ Anti-AFK System
local VirtualUser = game:GetService("VirtualUser")
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- üî∞ Buat Window utama
local ForgeAutomation = library:CreateWindow({
    Name = "Forge Automation",
    Themeable = {
        Info = "Auto Forge System - No Ore Selection\nPress RightShift to toggle"
    }
})

-- üî∞ Variabel untuk sistem forge
local autoForgeEnabled = false
local forgeThread = nil
local forgeDelay = 60
local consecutiveFailures = 0
local maxFailures = 3
local statusText = "Stopped"
local isForgeActive = false

-- üî∞ Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- üî∞ Services Knit
local ForgeController
local ForgeService

-- üî∞ Tunggu Knit services
local function waitForKnitServices()
    local startTime = tick()
    while tick() - startTime < 30 do
        local success, result = pcall(function()
            local Knit = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Packages").Knit)
            if Knit.IsReady then
                ForgeController = Knit.GetController("ForgeController")
                ForgeService = Knit.GetService("ForgeService")
                return ForgeController ~= nil and ForgeService ~= nil
            end
            return false
        end)
        
        if success and result then
            return true
        end
        task.wait(1)
    end
    return false
end

-- üî∞ Fungsi untuk check apakah forge sedang aktif
local function checkForgeActive()
    if not ForgeController then return false end
    return ForgeController.ForgeActive == true
end

-- üî∞ Fungsi untuk tunggu sampai ore dipilih (forge aktif)
local function waitForOreSelection()
    local startTime = tick()
    local timeout = 120 -- 2 menit timeout
    
    print("‚è≥ Waiting for ore selection in game...")
    
    while tick() - startTime < timeout do
        if not autoForgeEnabled then
            print("‚ùå Auto forge disabled while waiting")
            return false
        end
        
        if checkForgeActive() then
            print("‚úÖ Ore selection detected! Forge is active.")
            return true
        end
        
        task.wait(1)
        
        -- Update status setiap 10 detik
        if math.floor(tick() - startTime) % 10 == 0 then
            local elapsed = math.floor(tick() - startTime)
            print("‚è≥ Still waiting... (" .. elapsed .. "s elapsed)")
        end
    end
    
    print("‚ùå Timeout waiting for ore selection")
    return false
end

-- üî∞ Fungsi untuk execute forging sequence
local function executeForgingSequence()
    local success, errorMsg = pcall(function()
        -- Tunggu sampai forge aktif (ore sudah dipilih)
        if not checkForgeActive() then
            return false, "Forge is not active. Please select ores in game first."
        end

        print("üéØ Starting forge sequences...")
        
        -- Execute sequences yang tersisa
        local sequences = {"Melt", "Pour", "Hammer", "Water", "Showcase"}
        
        for _, sequence in ipairs(sequences) do
            if not autoForgeEnabled then break end
            
            print("üéØ Starting sequence: " .. sequence)
            
            local seqSuccess, seqError = pcall(function()
                ForgeController:ChangeSequence(sequence)
            end)
            
            if not seqSuccess then
                print("‚ö†Ô∏è Error in sequence " .. sequence .. ": " .. tostring(seqError))
            end
            
            -- Tunggu antara sequences
            local waitTime = sequence == "Melt" and 10 or 
                            sequence == "Hammer" and 8 or 
                            sequence == "Water" and 5 or 3
                            
            for i = 1, waitTime do
                if not autoForgeEnabled then break end
                task.wait(1)
            end
        end

        return true, "Forging completed successfully"
    end)

    if not success then
        return false, "Forging error: " .. tostring(errorMsg)
    end
    
    return success, errorMsg
end

-- üî∞ Fungsi untuk satu siklus forge lengkap
local function runForgeCycle()
    -- 1. Tunggu sampai ore dipilih di game
    local oreSelected = waitForOreSelection()
    if not oreSelected then
        return false, "Failed to detect ore selection"
    end
    
    -- 2. Jalankan forging sequence
    local success, message = executeForgingSequence()
    
    if success then
        print("‚úÖ " .. message)
        
        -- 3. Tunggu forge selesai dan kembali ke awal
        local waitStart = tick()
        while tick() - waitStart < 5 do
            if not autoForgeEnabled then break end
            if not checkForgeActive() then
                print("‚úÖ Forge cycle completed, ready for next cycle")
                break
            end
            task.wait(1)
        end
        
        return true, "Forge cycle completed"
    else
        return false, message
    end
end

-- üî∞ Auto Forge Loop
local function startAutoForgeLoop()
    if autoForgeEnabled then return end
    autoForgeEnabled = true
    consecutiveFailures = 0
    statusText = "Running"
    
    forgeThread = task.spawn(function()
        print("üöÄ Auto Forge started - Waiting for ore selection in game...")
        
        while autoForgeEnabled do
            local success, message = runForgeCycle()
            
            if success then
                consecutiveFailures = 0
                print("‚úÖ " .. message .. ", waiting " .. forgeDelay .. " seconds for next cycle...")
                
                -- Tunggu untuk next cycle
                for i = forgeDelay, 1, -1 do
                    if not autoForgeEnabled then break end
                    task.wait(1)
                end
            else
                consecutiveFailures = consecutiveFailures + 1
                print("‚ùå Forge cycle failed: " .. tostring(message))
                
                if consecutiveFailures >= maxFailures then
                    print("‚ùå Too many failures! Auto Forge stopped.")
                    stopAutoForgeLoop()
                    break
                end
                
                -- Tunggu sebelum retry
                local retryDelay = math.min(10 * consecutiveFailures, 30)
                print("‚è≥ Retrying in " .. retryDelay .. " seconds...")
                task.wait(retryDelay)
            end
        end
    end)
    
    library:Notify({
        Title = "Forge Automation",
        Content = "Auto Forge started!\nPlease select ores in game",
        Duration = 5
    })
end

local function stopAutoForgeLoop()
    autoForgeEnabled = false
    consecutiveFailures = 0
    statusText = "Stopped"
    if forgeThread then
        task.cancel(forgeThread)
    end
    print("üõë Auto Forge stopped!")
    library:Notify({
        Title = "Forge Automation",
        Content = "Auto Forge stopped!",
        Duration = 3
    })
end

-- üî∞ Manual trigger forging (setelah ore dipilih)
local function triggerForgeNow()
    if autoForgeEnabled then
        library:Notify({
            Title = "Forge Automation",
            Content = "Please stop auto forge first!",
            Duration = 3
        })
        return
    end
    
    task.spawn(function()
        local success, message = executeForgingSequence()
        if success then
            library:Notify({
                Title = "Forge Automation",
                Content = "Forging completed!",
                Duration = 3
            })
        else
            library:Notify({
                Title = "Forge Automation",
                Content = "Forging failed: " .. tostring(message),
                Duration = 5
            })
        end
    end)
end

-- üî∞ Buat Tab General
local GeneralTab = ForgeAutomation:CreateTab({
    Name = "Main"
})

-- üî∞ Auto Forge Section
local AutoForgeSection = GeneralTab:CreateSection({
    Name = "Auto Forge"
})

AutoForgeSection:AddToggle({
    Name = "Enable Auto Forge",
    Value = false,
    Flag = "AutoForge_Enabled",
    Callback = function(value)
        if value then
            startAutoForgeLoop()
        else
            stopAutoForgeLoop()
        end
    end
})

AutoForgeSection:AddButton({
    Name = "Trigger Forge Now",
    Callback = function()
        triggerForgeNow()
    end
})

AutoForgeSection:AddLabel({
    Text = "Status: Stopped",
    Flag = "AutoForge_Status"
})

AutoForgeSection:AddLabel({
    Text = "Note: Select ores in game first",
    Flag = "AutoForge_Note"
})

-- üî∞ Settings Section
local SettingsSection = GeneralTab:CreateSection({
    Name = "Settings",
    Side = "Right"
})

SettingsSection:AddSlider({
    Name = "Cycle Delay",
    Flag = "AutoForge_Delay",
    Value = 60,
    Precise = 0,
    Min = 30,
    Max = 300,
    Format = function(Value)
        return "Delay: " .. tostring(Value) .. "s"
    end,
    Callback = function(value)
        forgeDelay = value
        print("‚úÖ Cycle delay set to: " .. forgeDelay .. " seconds")
    end
})

SettingsSection:AddSlider({
    Name = "Max Failures",
    Flag = "AutoForge_MaxFailures",
    Value = 3,
    Min = 1,
    Max = 10,
    Format = function(Value)
        return "Max Failures: " .. tostring(Value)
    end,
    Callback = function(value)
        maxFailures = value
        print("‚úÖ Max failures set to: " .. maxFailures)
    end
})

-- üî∞ Status Tab
local StatusTab = ForgeAutomation:CreateTab({
    Name = "Status"
})

local StatusSection = StatusTab:CreateSection({
    Name = "Current Status"
})

StatusSection:AddLabel({
    Text = "Auto Forge: Stopped",
    Flag = "Status_AutoForge"
})

StatusSection:AddLabel({
    Text = "Consecutive Failures: 0",
    Flag = "Status_Failures"
})

StatusSection:AddLabel({
    Text = "Forge Active: No",
    Flag = "Status_ForgeActive"
})

StatusSection:AddLabel({
    Text = "Cycle Delay: 60s",
    Flag = "Status_Delay"
})

StatusSection:AddLabel({
    Text = "Instructions:",
    Flag = "Status_Instructions"
})

StatusSection:AddLabel({
    Text = "1. Go to forge station",
    Flag = "Status_Step1"
})

StatusSection:AddLabel({
    Text = "2. Select ores in game",
    Flag = "Status_Step2"
})

StatusSection:AddLabel({
    Text = "3. Enable Auto Forge",
    Flag = "Status_Step3"
})

-- üî∞ Debug Tab
local DebugTab = ForgeAutomation:CreateTab({
    Name = "Debug"
})

local DebugSection = DebugTab:CreateSection({
    Name = "Debug Tools"
})

DebugSection:AddButton({
    Name = "Check Forge Status",
    Callback = function()
        local isActive = checkForgeActive()
        local message = isActive and "Forge is ACTIVE (Ores selected)" or "Forge is INACTIVE (Select ores)"
        
        library:Notify({
            Title = "Forge Status",
            Content = message,
            Duration = 3
        })
        print("üîç " .. message)
    end
})

DebugSection:AddButton({
    Name = "Test Services",
    Callback = function()
        local servicesReady = waitForKnitServices()
        if servicesReady then
            library:Notify({
                Title = "Services",
                Content = "Forge services: READY",
                Duration = 3
            })
            print("‚úÖ Forge services: READY")
        else
            library:Notify({
                Title = "Services",
                Content = "Forge services: NOT FOUND",
                Duration = 3
            })
            print("‚ùå Forge services: NOT FOUND")
        end
    end
})

DebugSection:AddToggle({
    Name = "Verbose Logging",
    Value = false,
    Flag = "Debug_Verbose",
    Callback = function(value)
        if value then
            print("üîß Verbose logging enabled")
        else
            print("üîß Verbose logging disabled")
        end
    end
})

-- üî∞ Update status function
local function updateStatus()
    local autoForgeStatus = autoForgeEnabled and "Running" or "Stopped"
    local forgeActiveStatus = checkForgeActive() and "Yes" or "No"
    
    -- Update status labels
    if ForgeAutomation.Flags.AutoForge_Status then
        ForgeAutomation.Flags.AutoForge_Status = "Status: " .. autoForgeStatus
    end
    
    if ForgeAutomation.Flags.Status_AutoForge then
        ForgeAutomation.Flags.Status_AutoForge = "Auto Forge: " .. autoForgeStatus
    end
    
    if ForgeAutomation.Flags.Status_Failures then
        ForgeAutomation.Flags.Status_Failures = "Consecutive Failures: " .. tostring(consecutiveFailures)
    end
    
    if ForgeAutomation.Flags.Status_ForgeActive then
        ForgeAutomation.Flags.Status_ForgeActive = "Forge Active: " .. forgeActiveStatus
    end
    
    if ForgeAutomation.Flags.Status_Delay then
        ForgeAutomation.Flags.Status_Delay = "Cycle Delay: " .. tostring(forgeDelay) .. "s"
    end
    
    -- Update instructions based on status
    if ForgeAutomation.Flags.AutoForge_Note then
        if autoForgeEnabled then
            ForgeAutomation.Flags.AutoForge_Note = "Note: Auto forge running, select ores in game"
        else
            ForgeAutomation.Flags.AutoForge_Note = "Note: Enable auto forge after selecting ores"
        end
    end
end

-- üî∞ Auto update status
task.spawn(function()
    while Wait() do
        updateStatus()
        Wait(1)
    end
end)

-- üî∞ Auto-initialize services
task.spawn(function()
    print("üîÑ Initializing forge automation...")
    local servicesReady = waitForKnitServices()
    if servicesReady then
        print("‚úÖ Forge services initialized successfully!")
        
        -- Set initial status
        updateStatus()
        
        library:Notify({
            Title = "Forge Automation",
            Content = "Ready! Select ores in game, then enable Auto Forge",
            Duration = 5
        })
    else
        print("‚ùå Failed to initialize forge services!")
        
        library:Notify({
            Title = "Forge Automation",
            Content = "Error: Forge services not found",
            Duration = 5
        })
    end
end)

-- üî∞ Set keybind untuk toggle GUI
library:SetKeybind("RightShift")

-- üî∞ Print welcome message
print("====================================")
print("üî® Forge Automation - No Ore Selection")
print("üîß Press RightShift to open/close GUI")
print("üìã Instructions:")
print("1. Go to forge station in game")
print("2. Select ores manually")
print("3. Enable Auto Forge in GUI")
print("====================================")

-- üî∞ Designer untuk customisasi GUI
ForgeAutomation:CreateDesigner({
    Info = {
        "Forge Automation System",
        "No Ore Selection Required",
        "Select ores in game first",
        "Then enable Auto Forge"
    },
    Credit = true
})

-- üî∞ Cleanup
library.signals:connection(game:GetService("Players").LocalPlayer.CharacterRemoving, function()
    if autoForgeEnabled then
        stopAutoForgeLoop()
    end
    print("üßπ Cleaning up forge automation...")
end)

-- üî∞ Auto check forge status periodically
task.spawn(function()
    while Wait() do
        if autoForgeEnabled then
            local forgeActive = checkForgeActive()
            if forgeActive and not isForgeActive then
                print("‚úÖ Forge became active (ores selected)")
                isForgeActive = true
            elseif not forgeActive and isForgeActive then
                print("‚ÑπÔ∏è Forge completed or reset")
                isForgeActive = false
            end
        end
        Wait(2)
    end
end)
