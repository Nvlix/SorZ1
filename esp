-- ============================================================
-- ROCK ESP (Forge Resource Locator)
-- Made by JawirScript (Modified from mrpopcat14)
-- ============================================================

local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Table to keep track of highlighted objects
local highlightedObjects = {}
local ESPEnabled = true
local ESPDistance = 300  -- Max distance in studs
local updateInterval = 0.2  -- Update every 0.2 seconds
local lastUpdate = 0

-- Configuration for different rock types
local RockConfigs = {
    Pebble = {
        Name = "Pebble",
        Color = Color3.fromRGB(180, 160, 140),  -- Light brown
        SizeOffset = Vector3.new(0, 1.5, 0),    -- Position offset
        BillboardSize = UDim2.new(0, 60, 0, 30), -- Smaller for pebbles
        TextSize = 14,
        ShowTracer = false,  -- Don't show tracer for small rocks
        Priority = 3
    },
    Rock = {
        Name = "Rock",
        Color = Color3.fromRGB(150, 120, 90),   -- Medium brown
        SizeOffset = Vector3.new(0, 2, 0),
        BillboardSize = UDim2.new(0, 80, 0, 40),
        TextSize = 16,
        ShowTracer = true,
        Priority = 2
    },
    Boulder = {
        Name = "Boulder",
        Color = Color3.fromRGB(120, 85, 60),    -- Dark brown
        SizeOffset = Vector3.new(0, 3, 0),
        BillboardSize = UDim2.new(0, 100, 0, 50),
        TextSize = 18,
        ShowTracer = true,
        Priority = 1
    }
}

-- Function to create ESP for a rock
local function createRockESP(obj)
    local config = RockConfigs[obj.Parent.Name]
    if not config then return end
    
    -- Check if already has ESP
    if highlightedObjects[obj] then return end
    
    -- Calculate initial distance
    local character = LocalPlayer.Character
    local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")
    local distance = 0
    
    if humanoidRootPart then
        distance = (obj.Position - humanoidRootPart.Position).Magnitude
    end
    
    -- Create BillboardGui
    local BillboardGui = Instance.new('BillboardGui')
    local TextLabel = Instance.new('TextLabel')
    local DistanceLabel = Instance.new('TextLabel')
    
    BillboardGui.Name = "RockESP"
    BillboardGui.Parent = obj
    BillboardGui.AlwaysOnTop = true
    BillboardGui.Size = config.BillboardSize
    BillboardGui.StudsOffset = config.SizeOffset
    BillboardGui.MaxDistance = ESPDistance
    BillboardGui.Enabled = ESPEnabled
    
    -- Main label (rock type)
    TextLabel.Name = "TypeLabel"
    TextLabel.Parent = BillboardGui
    TextLabel.BackgroundTransparency = 1
    TextLabel.Size = UDim2.new(1, 0, 0.6, 0)
    TextLabel.Position = UDim2.new(0, 0, 0, 0)
    TextLabel.Text = config.Name
    TextLabel.TextColor3 = config.Color
    TextLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    TextLabel.TextStrokeTransparency = 0.5
    TextLabel.TextSize = config.TextSize
    TextLabel.Font = Enum.Font.SourceSansBold
    TextLabel.TextScaled = false
    
    -- Distance label
    DistanceLabel.Name = "DistanceLabel"
    DistanceLabel.Parent = BillboardGui
    DistanceLabel.BackgroundTransparency = 1
    DistanceLabel.Size = UDim2.new(1, 0, 0.4, 0)
    DistanceLabel.Position = UDim2.new(0, 0, 0.6, 0)
    DistanceLabel.Text = string.format("%.1f studs", distance)
    DistanceLabel.TextColor3 = Color3.new(1, 1, 1)
    DistanceLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    DistanceLabel.TextStrokeTransparency = 0.5
    DistanceLabel.TextSize = config.TextSize - 2
    DistanceLabel.Font = Enum.Font.SourceSans
    
    -- Create highlight box
    local highlight = Instance.new("BoxHandleAdornment")
    highlight.Name = "RockHighlight"
    highlight.Adornee = obj
    highlight.AlwaysOnTop = true
    highlight.ZIndex = 10
    highlight.Size = obj.Size + Vector3.new(0.3, 0.3, 0.3)
    highlight.Color3 = config.Color
    highlight.Transparency = 0.3
    highlight.Visible = ESPEnabled
    highlight.Parent = obj
    
    -- Create tracer line (for larger rocks)
    local tracer = nil
    if config.ShowTracer then
        tracer = Instance.new("LineHandleAdornment")
        tracer.Name = "RockTracer"
        tracer.Adornee = obj
        tracer.AlwaysOnTop = true
        tracer.ZIndex = 5
        tracer.Thickness = 2
        tracer.Color3 = config.Color
        tracer.Transparency = 0.4
        tracer.Visible = ESPEnabled
        tracer.Parent = obj
    end
    
    -- Create glow effect
    local pointLight = Instance.new("PointLight")
    pointLight.Name = "RockGlow"
    pointLight.Color = config.Color
    pointLight.Brightness = 1.5
    pointLight.Range = 15
    pointLight.Enabled = ESPEnabled
    pointLight.Shadows = false
    pointLight.Parent = obj
    
    -- Store ESP objects
    highlightedObjects[obj] = {
        Billboard = BillboardGui,
        Highlight = highlight,
        Tracer = tracer,
        Light = pointLight,
        Config = config,
        LastUpdate = tick()
    }
    
    print(string.format("[ROCK ESP] Created ESP for %s (Distance: %.1f)", config.Name, distance))
end

-- Function to update ESP (distance, colors, etc.)
local function updateRockESP(obj, espData)
    if not obj or not obj.Parent then
        return false  -- Object no longer exists
    end
    
    local character = LocalPlayer.Character
    local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")
    
    if not humanoidRootPart then return true end
    
    -- Calculate distance
    local distance = (obj.Position - humanoidRootPart.Position).Magnitude
    
    -- Update distance label
    if espData.Billboard and espData.Billboard:FindFirstChild("DistanceLabel") then
        espData.Billboard.DistanceLabel.Text = string.format("%.1f studs", distance)
        
        -- Update color based on distance
        local hue = (tick() % 3) / 3  -- Cycle through colors every 3 seconds
        local baseColor = espData.Config.Color
        
        if distance < 20 then
            -- Very close - bright green
            espData.Billboard.TypeLabel.TextColor3 = Color3.new(0, 1, 0)
        elseif distance < 50 then
            -- Close - yellow/orange
            espData.Billboard.TypeLabel.TextColor3 = Color3.fromHSV(hue, 1, 1)
        elseif distance < 100 then
            -- Medium - use base color with some variation
            espData.Billboard.TypeLabel.TextColor3 = baseColor
        else
            -- Far - slightly transparent
            espData.Billboard.TypeLabel.TextColor3 = Color3.new(
                baseColor.R * 0.7,
                baseColor.G * 0.7,
                baseColor.B * 0.7
            )
        end
        
        -- Update highlight color
        if espData.Highlight then
            espData.Highlight.Color3 = espData.Billboard.TypeLabel.TextColor3
        end
        
        -- Update tracer if exists
        if espData.Tracer then
            espData.Tracer.Color3 = espData.Billboard.TypeLabel.TextColor3
            
            -- Update tracer line from camera to rock
            local camera = Workspace.CurrentCamera
            if camera then
                espData.Tracer.Length = (obj.Position - camera.CFrame.Position).Magnitude
                espData.Tracer.CFrame = CFrame.lookAt(obj.Position, camera.CFrame.Position)
            end
        end
        
        -- Update light intensity based on distance
        if espData.Light then
            espData.Light.Brightness = math.clamp(30 / distance, 0.5, 3)
        end
        
        -- Enable/disable based on distance
        local shouldShow = distance <= ESPDistance
        espData.Billboard.Enabled = ESPEnabled and shouldShow
        espData.Highlight.Visible = ESPEnabled and shouldShow
        if espData.Tracer then
            espData.Tracer.Visible = ESPEnabled and shouldShow
        end
        espData.Light.Enabled = ESPEnabled and shouldShow
    end
    
    espData.LastUpdate = tick()
    return true
end

-- Function to check and create ESP for a single object
local function handleNewObject(obj)
    if obj:IsA('Part') and obj.Parent and obj.Parent:IsA('Model') then
        local parentName = obj.Parent.Name
        if parentName == 'Pebble' or parentName == 'Rock' or parentName == 'Boulder' then
            -- Check if the object is not already highlighted
            if not highlightedObjects[obj] then
                createRockESP(obj)
            end
        end
    end
end

-- Function to batch handle all existing objects
local function handleExistingObjects()
    for _, obj in ipairs(Workspace:GetDescendants()) do
        handleNewObject(obj)
    end
end

-- Clean up ESP for objects that no longer exist
local function cleanupESP()
    local toRemove = {}
    
    for obj, espData in pairs(highlightedObjects) do
        if not obj or not obj.Parent then
            -- Object was destroyed, remove ESP
            if espData.Billboard then espData.Billboard:Destroy() end
            if espData.Highlight then espData.Highlight:Destroy() end
            if espData.Tracer then espData.Tracer:Destroy() end
            if espData.Light then espData.Light:Destroy() end
            table.insert(toRemove, obj)
        end
    end
    
    -- Remove from table
    for _, obj in ipairs(toRemove) do
        highlightedObjects[obj] = nil
    end
end

-- Main update loop
local function mainUpdate()
    local currentTime = tick()
    
    if currentTime - lastUpdate >= updateInterval then
        -- Clean up first
        cleanupESP()
        
        -- Update existing ESP objects
        for obj, espData in pairs(highlightedObjects) do
            if currentTime - espData.LastUpdate >= updateInterval then
                local stillExists = updateRockESP(obj, espData)
                if not stillExists then
                    highlightedObjects[obj] = nil
                end
            end
        end
        
        -- Scan for new rocks (less frequent)
        if currentTime - lastUpdate >= 1 then  -- Full scan every 1 second
            handleExistingObjects()
        end
        
        lastUpdate = currentTime
    end
end

-- Function to toggle ESP on/off
local function toggleESP()
    ESPEnabled = not ESPEnabled
    
    -- Update all ESP objects
    for obj, espData in pairs(highlightedObjects) do
        if espData.Billboard then
            espData.Billboard.Enabled = ESPEnabled
        end
        if espData.Highlight then
            espData.Highlight.Visible = ESPEnabled
        end
        if espData.Tracer then
            espData.Tracer.Visible = ESPEnabled
        end
        if espData.Light then
            espData.Light.Enabled = ESPEnabled
        end
    end
    
    print("[ROCK ESP] " .. (ESPEnabled and "ENABLED" or "DISABLED"))
    return ESPEnabled
end

-- Function to set ESP distance
local function setESPDistance(distance)
    ESPDistance = math.clamp(distance, 10, 1000)
    print("[ROCK ESP] Distance set to: " .. ESPDistance .. " studs")
end

-- Function to set update interval
local function setUpdateInterval(interval)
    updateInterval = math.clamp(interval, 0.05, 2)
    print("[ROCK ESP] Update interval set to: " .. updateInterval .. " seconds")
end

-- Initialize event listeners
Workspace.ChildAdded:Connect(function(child)
    -- Check child and all descendants
    task.wait(0.1)  -- Wait a bit for child to fully load
    handleNewObject(child)
    
    -- Also check descendants
    for _, descendant in ipairs(child:GetDescendants()) do
        handleNewObject(descendant)
    end
end)

-- Listen for descendant additions (for nested rocks)
Workspace.DescendantAdded:Connect(function(descendant)
    handleNewObject(descendant)
end)

-- Listen for descendant removals
Workspace.DescendantRemoving:Connect(function(descendant)
    if highlightedObjects[descendant] then
        local espData = highlightedObjects[descendant]
        if espData.Billboard then espData.Billboard:Destroy() end
        if espData.Highlight then espData.Highlight:Destroy() end
        if espData.Tracer then espData.Tracer:Destroy() end
        if espData.Light then espData.Light:Destroy() end
        highlightedObjects[descendant] = nil
    end
end)

-- Start the main update loop
local connection = RunService.Heartbeat:Connect(mainUpdate)

-- Initial scan
task.spawn(function()
    task.wait(3)  -- Wait for game to load
    print("[ROCK ESP] Performing initial scan...")
    handleExistingObjects()
    print("[ROCK ESP] Initial scan complete. Found " .. #highlightedObjects .. " rocks.")
end)

-- Cleanup function
local function cleanup()
    if connection then
        connection:Disconnect()
        connection = nil
    end
    
    -- Remove all ESP objects
    for obj, espData in pairs(highlightedObjects) do
        if espData.Billboard then espData.Billboard:Destroy() end
        if espData.Highlight then espData.Highlight:Destroy() end
        if espData.Tracer then espData.Tracer:Destroy() end
        if espData.Light then espData.Light:Destroy() end
    end
    
    highlightedObjects = {}
    print("[ROCK ESP] Cleaned up")
end

-- Bind cleanup to game close
game:BindToClose(function()
    cleanup()
end)

-- Return public API
return {
    ToggleESP = toggleESP,
    SetDistance = setESPDistance,
    SetUpdateInterval = setUpdateInterval,
    GetStatus = function()
        local count = {
            Pebble = 0,
            Rock = 0,
            Boulder = 0,
            Total = 0
        }
        
        for obj, espData in pairs(highlightedObjects) do
            if obj and obj.Parent then
                local parentName = obj.Parent.Name
                if parentName == 'Pebble' then
                    count.Pebble = count.Pebble + 1
                elseif parentName == 'Rock' then
                    count.Rock = count.Rock + 1
                elseif parentName == 'Boulder' then
                    count.Boulder = count.Boulder + 1
                end
                count.Total = count.Total + 1
            end
        end
        
        return {
            Enabled = ESPEnabled,
            Distance = ESPDistance,
            UpdateInterval = updateInterval,
            Count = count,
            RockCount = count.Total
        }
    end,
    Refresh = function()
        handleExistingObjects()
        local status = {}
        for obj, espData in pairs(highlightedObjects) do
            if obj and obj.Parent then
                table.insert(status, {
                    Type = obj.Parent.Name,
                    Position = obj.Position,
                    Distance = (obj.Position - (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position or Vector3.new())).Magnitude
                })
            end
        end
        return status
    end,
    Cleanup = cleanup
}
